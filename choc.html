<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chocolate Stand Tycoon v4 (Local Storage)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce7f3; /* Light pink/chocolate background */
            transition: background-color 0.3s;
        }
        body.dark {
            background-color: #1f2937; /* Dark gray for dark mode */
        }
        .container {
            min-height: 100vh;
        }
        .chocolate-card {
            background-color: #ffffff;
            border: 2px solid #be185d;
            box-shadow: 0 10px 15px -3px rgba(190, 24, 93, 0.3), 0 4px 6px -2px rgba(190, 24, 93, 0.1);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        .dark .chocolate-card {
            background-color: #374151; /* Dark card background */
            border-color: #9d174d; /* Darker pink border */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            color: #d1d5db; /* Light text */
        }
        
        /* Custom scrollbar for log */
        #log-area::-webkit-scrollbar {
            width: 6px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background: #f472b6;
            border-radius: 3px;
        }
        .dark #log-area::-webkit-scrollbar-thumb {
            background: #9d174d;
        }

        /* Toggle switch styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #9d174d;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #be185d;
        }

        /* Rich Chocolate Toggle Specifics */
        .rich-chocolate-toggle:checked + .toggle-label {
            background-color: #5d2508; /* Dark brown for rich chocolate */
        }
        .rich-chocolate-toggle:checked + .toggle-label .toggle-checkbox {
            background-color: #fca5a5; /* Reddish white dot */
        }
        
        /* Day Transition Overlay Styles */
        #day-transition-overlay {
            /* Full dark background */
            background-color: rgba(0, 0, 0, 1);
            /* Initially hidden with opacity 0 and no pointer events */
            opacity: 0;
            pointer-events: none;
            transition: opacity 5.0s ease-in-out; /* Match the 5s transition */
        }
        #day-transition-overlay.active {
            /* Makes it visible and interactive during transition */
            opacity: 1;
            pointer-events: auto;
        }
        .saving-spinner {
            /* Styles for the loading spinner */
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: #f472b6; /* Pink spinner color */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <!-- The main game script -->
    <script>
        // Game Constants
        const BASE_COST_PER_BAR = 1.50;
        const RICH_CHOCOLATE_BONUS_COST = 0.75; // Total cost: $2.25
        const RICH_CHOCOLATE_MAX_PRICE_BONUS = 2.00; // Customers tolerate up to $2.00 more on the max profitable price
        const BASE_MAX_ORDERS = 10;
        const BASE_MAX_ACCEPTABLE_PRICE = 10.00; // Base max acceptable price without rich chocolate

        const UPGRADE_CONFIG = {
            BANNER_1: { key: 'BANNER_1', name: "Small Banner Ad", cost: 150.00, orderIncrease: 5, description: "A simple banner to catch local attention." },
            BANNER_2: { key: 'BANNER_2', name: "Large Digital Sign", cost: 400.00, orderIncrease: 10, description: "A dazzling sign attracting customers from afar." },
            TIKTOK_PAGE: { key: 'TIKTOK_PAGE', name: "Launch TikTok Page", cost: 800.00, orderIncrease: 15, description: "Go viral! Massive reach and high customer hype." },
        };

        // Default Game State Variables
        const DEFAULT_GAME_STATE = {
            money: 100.00,
            day: 0,
            weather: 'Sunny',
            totalOrders: 0,
            ordersRemaining: 0,
            acceptedOrders: 0,
            rejectedOrders: 0,
            isProcessing: false, 
            upgrades: {
                bannerLevel: 0, 
                tiktokPage: false,
            },
            richChocolate: {
                isActive: false, 
            }
        };

        let gameState = { ...DEFAULT_GAME_STATE };

        let settingsState = {
            isDarkMode: false,
        };

        // Local Storage Keys
        const GAME_DATA_KEY = 'cs_tycoon_game_data'; 
        const SETTINGS_KEY = 'cs_tycoon_settings';

        const WEATHER_EFFECTS = {
            'Sunny': { effect: 1.2, emoji: '‚òÄÔ∏è', message: 'Perfect weather! Customers are thirsty for chocolate.' },
            'Cloudy': { effect: 1.0, emoji: '‚òÅÔ∏è', message: 'Average day. Business as usual.' },
            'Rainy': { effect: 0.8, emoji: 'üåßÔ∏è', message: 'Gloomy day. Fewer people out, but they want comfort food.' },
            'Heatwave': { effect: 0.6, emoji: 'üî•', message: 'It\'s melting! Price must be low or they won\'t risk it.' },
            'Snowing': { effect: 1.5, emoji: '‚ùÑÔ∏è', message: 'Cold weather brings high demand for hot chocolate (and bars!).' }
        };

        const CUSTOMER_PROMPT_STANDARD = "A customer approaches. What price will you set for a single chocolate bar?";
        const CUSTOMER_PROMPT_RICH = "A delighted customer approaches, smelling the rich cocoa. What premium price will you set?";
        
        // --- Utility functions for TTS (Kept for compatibility) ---
        window.base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        window.pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); 
            view.setUint16(32, numChannels * bytesPerSample, true); 
            view.setUint16(34, 16, true); 
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);
            const pcmView = new Int16Array(pcmData);
            for (let i = 0; i < pcmView.length; i++) {
                view.setInt16(44 + i * 2, pcmView[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // --- TTS Utility (Simplified for the game flow focus) ---
        async function speakText(text) {
            const ttsButton = document.getElementById('prompt-tts');
            if (ttsButton) {
                ttsButton.disabled = true;
                ttsButton.classList.add('opacity-50');
            }

            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } },
                    model: "gemini-2.5-flash-preview-tts"
                };

                let response = null;
                const maxRetries = 3;
                let success = false;

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) { success = true; break; }
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (!success) { throw new Error("TTS service is currently unavailable or rate limited."); }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = window.base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = window.pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        if (ttsButton) {
                            ttsButton.disabled = false;
                            ttsButton.classList.remove('opacity-50');
                        }
                        URL.revokeObjectURL(audioUrl);
                    };
                } else {
                    console.error("TTS response missing audio data or invalid format.");
                    throw new Error("Invalid TTS response from server.");
                }

            } catch (error) {
                console.error("TTS generation error:", error);
                logMessage("üîä TTS feature unavailable. Console logs contain error details.", 'error');
                if (ttsButton) {
                    ttsButton.disabled = false;
                    ttsButton.classList.remove('opacity-50');
                }
            }
        }
        window.speakText = speakText; 

        // === Settings and Theme Functions (using localStorage) ===
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                if (storedSettings) {
                    const loaded = JSON.parse(storedSettings);
                    settingsState.isDarkMode = loaded.isDarkMode || false;
                }
            } catch (e) {
                console.error("Error loading settings from localStorage:", e);
            }
            applyTheme();
        }
        window.loadSettings = loadSettings;

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsState));
            } catch (e) {
                console.error("Error saving settings to localStorage:", e);
            }
        }

        function applyTheme() {
            if (settingsState.isDarkMode) {
                document.documentElement.classList.add('dark');
                document.body.classList.add('dark');
                document.getElementById('dark-mode-toggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('dark');
                document.getElementById('dark-mode-toggle').checked = false;
            }
        }

        function toggleDarkMode() {
            settingsState.isDarkMode = !settingsState.isDarkMode;
            applyTheme();
            saveSettings();
        }
        window.toggleDarkMode = toggleDarkMode; 
        

        function updateUI() {
            document.getElementById('day-display').textContent = gameState.day;
            document.getElementById('money-display').textContent = gameState.money.toFixed(2);
            document.getElementById('orders-remaining').textContent = gameState.ordersRemaining;
            document.getElementById('total-orders').textContent = gameState.totalOrders;
            document.getElementById('weather-display').innerHTML = `${WEATHER_EFFECTS[gameState.weather].emoji} ${gameState.weather}`;
            document.getElementById('weather-info').textContent = WEATHER_EFFECTS[gameState.weather].message;

            const interactionArea = document.getElementById('interaction-area');
            const endDayBtn = document.getElementById('end-day-button');
            const richToggle = document.getElementById('rich-chocolate-toggle');

            // Set Rich Chocolate Toggle State
            richToggle.checked = gameState.richChocolate.isActive;

            if (gameState.ordersRemaining > 0) {
                // Show customer interaction
                endDayBtn.classList.add('hidden');
                interactionArea.classList.remove('hidden');
                
                // Update prompt based on Rich Chocolate status
                document.getElementById('prompt-text').textContent = gameState.richChocolate.isActive ? CUSTOMER_PROMPT_RICH : CUSTOMER_PROMPT_STANDARD;

                // Update input placeholder based on current cost
                const currentCost = gameState.richChocolate.isActive ? (BASE_COST_PER_BAR + RICH_CHOCOLATE_BONUS_COST).toFixed(2) : BASE_COST_PER_BAR.toFixed(2);
                document.getElementById('price-info').textContent = `Cost per bar: $${currentCost}`;
                
            } else {
                // Show end day button and summary
                interactionArea.classList.add('hidden');
                endDayBtn.classList.remove('hidden');
            }
        }

        function logMessage(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const logEntry = document.createElement('div');
            let color = '';
            let darkModeColor = '';
            if (type === 'success') {
                color = 'text-green-600';
                darkModeColor = 'dark:text-green-400';
            } else if (type === 'error') {
                color = 'text-red-600';
                darkModeColor = 'dark:text-red-400';
            } else {
                color = 'text-gray-700';
                darkModeColor = 'dark:text-gray-300';
            }

            logEntry.className = `p-2 ${color} ${darkModeColor} border-b border-gray-100 dark:border-gray-700`;
            logEntry.textContent = message;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight; // Auto-scroll to bottom
        }

        // === Upgrades Logic ===

        function renderUpgradesModal() {
            const container = document.getElementById('upgrades-list');
            container.innerHTML = '';
            const upgrades = [UPGRADE_CONFIG.BANNER_1, UPGRADE_CONFIG.BANNER_2, UPGRADE_CONFIG.TIKTOK_PAGE];

            upgrades.forEach(config => {
                let status = '';
                let isPurchased = false;
                let isDisabled = false;

                if (config.key.startsWith('BANNER')) {
                    const level = config.key.endsWith('1') ? 1 : 2;
                    isPurchased = gameState.upgrades.bannerLevel >= level;
                    if (level === 2 && gameState.upgrades.bannerLevel < 1) {
                        isDisabled = true;
                        status = 'Requires Small Banner Ad';
                    } else if (isPurchased) {
                        status = 'Purchased';
                    }
                } else if (config.key === 'TIKTOK_PAGE') {
                    isPurchased = gameState.upgrades.tiktokPage;
                    if (isPurchased) {
                        status = 'Purchased';
                    }
                }
                
                if (isPurchased) {
                    status = `<span class="text-green-500 font-bold">OWNED</span>`;
                } else if (gameState.money < config.cost || isDisabled) {
                    status = `<span class="text-red-500 font-bold">Cost: $${config.cost.toFixed(2)}</span>`;
                    isDisabled = true;
                } else {
                    status = `<span class="text-blue-500 font-bold">Cost: $${config.cost.toFixed(2)}</span>`;
                }

                const buttonClass = isPurchased ? 'bg-gray-400 cursor-not-allowed' : (isDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700');
                const buttonText = isPurchased ? 'Owned' : (isDisabled ? 'Locked' : 'Buy');

                container.innerHTML += `
                    <div class="p-4 chocolate-card rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0">
                        <div>
                            <p class="text-lg font-semibold dark:text-gray-200">${config.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${config.description}</p>
                            <p class="text-sm mt-1">${status}</p>
                        </div>
                        <button 
                            onclick="buyUpgrade('${config.key}')" 
                            class="w-full md:w-auto px-4 py-2 text-white font-bold rounded-lg transition duration-150 ${buttonClass}" 
                            ${isDisabled || isPurchased ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            document.getElementById('upgrades-modal').classList.remove('hidden');
        }
        window.renderUpgradesModal = renderUpgradesModal;


        function buyUpgrade(upgradeKey) {
            const config = UPGRADE_CONFIG[upgradeKey];
            if (!config) {
                logMessage("Error: Invalid upgrade key.", 'error');
                return;
            }

            if (gameState.money < config.cost) {
                logMessage(`Cannot afford ${config.name}. Need $${config.cost.toFixed(2)}.`, 'error');
                return;
            }

            if (upgradeKey.startsWith('BANNER')) {
                const level = upgradeKey.endsWith('1') ? 1 : 2;
                if (gameState.upgrades.bannerLevel === level) {
                    logMessage(`${config.name} already purchased!`, 'info');
                    return;
                }
                if (level === 2 && gameState.upgrades.bannerLevel < 1) {
                    logMessage("Must purchase Small Banner Ad first.", 'error');
                    return;
                }

                gameState.money -= config.cost;
                gameState.upgrades.bannerLevel = level;
                logMessage(`Purchased ${config.name}! Max daily orders increased by ${config.orderIncrease}.`, 'success');

            } else if (upgradeKey === 'TIKTOK_PAGE') {
                if (gameState.upgrades.tiktokPage) {
                    logMessage("TikTok Page already launched!", 'info');
                    return;
                }
                gameState.money -= config.cost;
                gameState.upgrades.tiktokPage = true;
                logMessage(`Launched TikTok Page! Max daily orders increased by ${config.orderIncrease} and customer hype is massive!`, 'success');
            }

            updateUI();
            saveGame();
            renderUpgradesModal(); // Re-render to update status
        }
        window.buyUpgrade = buyUpgrade;


        // === Game Logic ===

        function toggleRichChocolate() {
            gameState.richChocolate.isActive = !gameState.richChocolate.isActive;
            logMessage(`Rich Chocolate mode is now ${gameState.richChocolate.isActive ? 'ACTIVE' : 'INACTIVE'}. Next customer will reflect this choice.`, 'info');
            updateUI();
            saveGame();
        }
        window.toggleRichChocolate = toggleRichChocolate;


        /**
         * The core logic for starting a new day (after the transition).
         */
        function startNewDayLogic() {
            gameState.day += 1;
            gameState.acceptedOrders = 0;
            gameState.rejectedOrders = 0;

            // Log previous day's final score
            if (gameState.day > 1) {
                logMessage(`--- END OF DAY ${gameState.day - 1} SUMMARY ---`, 'info');
                // Accepted/Rejected orders are reset before this point, so this log is inaccurate.
                // Re-initializing gameState.acceptedOrders and rejectedOrders *after* this log for accuracy.
                // For simplicity in this local storage version, we just log the money gain.
                // To fix the log, we'd need to track day summary data separately.
                // For now, removing the inaccurate orders log:
            }

            // Random Weather Selection
            const weatherKeys = Object.keys(WEATHER_EFFECTS);
            gameState.weather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];

            // Calculate max base orders based on upgrades
            let maxBaseOrders = BASE_MAX_ORDERS;
            if (gameState.upgrades.bannerLevel >= 1) {
                maxBaseOrders += UPGRADE_CONFIG.BANNER_1.orderIncrease;
            }
            if (gameState.upgrades.bannerLevel >= 2) {
                maxBaseOrders += UPGRADE_CONFIG.BANNER_2.orderIncrease;
            }
            if (gameState.upgrades.tiktokPage) {
                maxBaseOrders += UPGRADE_CONFIG.TIKTOK_PAGE.orderIncrease;
            }

            // Random Orders: Base orders + random fluctuation (e.g., up to 50% of base)
            const fluctuation = Math.floor(Math.random() * (maxBaseOrders / 2));
            gameState.totalOrders = Math.max(5, maxBaseOrders + fluctuation); // Ensure at least 5 orders
            gameState.ordersRemaining = gameState.totalOrders;

            logMessage(`--- DAY ${gameState.day} BEGINS ---`, 'info');
            logMessage(`Weather is ${gameState.weather}. Max expected customers: ${gameState.totalOrders}.`, 'info');

            updateUI();
        }

        /**
         * Handles the visual transition, saving, and then starting a new day.
         */
        async function startNewDay() {
            if (gameState.isProcessing) return;
            gameState.isProcessing = true;
            
            const overlay = document.getElementById('day-transition-overlay');
            const endDayBtn = document.getElementById('end-day-button');

            // 1. Show overlay (fade to black)
            endDayBtn.disabled = true;
            overlay.classList.add('active'); // CSS handles transition opacity over 5s

            // Wait 100ms for the visual transition to start before saving
            await new Promise(resolve => setTimeout(resolve, 100)); 

            // 2. Save game state persistently via localStorage while the screen is dark
            logMessage("Saving game state to local storage...", 'info');
            await saveGame();
            logMessage("Save successful.", 'info');
            
            // 3. Wait for the remainder of the 5 seconds for the visual effect
            await new Promise(resolve => setTimeout(resolve, 4900)); // Total 5000ms wait
            
            // 4. Execute the new day logic
            startNewDayLogic();

            // 5. Hide overlay
            overlay.classList.remove('active');
            endDayBtn.disabled = false;
            gameState.isProcessing = false;
        }
        window.startNewDay = startNewDay;


        // Core Decision Logic
        function checkAcceptance(price) {
            const isRich = gameState.richChocolate.isActive;
            let costOfGoods = BASE_COST_PER_BAR;
            let maxAcceptablePrice = BASE_MAX_ACCEPTABLE_PRICE;

            if (isRich) {
                costOfGoods += RICH_CHOCOLATE_BONUS_COST;
                maxAcceptablePrice += RICH_CHOCOLATE_MAX_PRICE_BONUS;
            }
            
            // Normalize price against the profitable range (costOfGoods to maxAcceptablePrice)
            const priceRange = maxAcceptablePrice - costOfGoods;
            const normalizedPrice = Math.max(0, price - costOfGoods) / priceRange;
            
            // Acceptance chance drops sharply as normalizedPrice increases.
            // Using a power of 2.5 makes the drop steeper for higher prices.
            const baseChance = Math.max(0, 1 - Math.pow(normalizedPrice, 2.5));

            // Apply weather modifier
            const weatherEffect = WEATHER_EFFECTS[gameState.weather].effect;
            let finalChance = baseChance * weatherEffect;
            
            // Cap chance at 100%
            finalChance = Math.min(1.0, finalChance);
            
            // Random check
            const roll = Math.random();

            return {
                accepts: roll < finalChance,
                chance: finalChance,
                cost: costOfGoods
            };
        }

        function handlePriceSetting() {
            if (gameState.isProcessing) return;

            const priceInput = document.getElementById('price-input');
            const price = parseFloat(priceInput.value);

            if (isNaN(price) || price <= 0) {
                logMessage("Please enter a valid price greater than $0.", 'error');
                return;
            }

            gameState.isProcessing = true;
            document.getElementById('set-price-button').disabled = true;

            const { accepts, chance, cost } = checkAcceptance(price);
            const weatherEmoji = WEATHER_EFFECTS[gameState.weather].emoji;

            let message;

            if (accepts) {
                const profit = price - cost;
                gameState.money += profit;
                gameState.acceptedOrders += 1;
                message = `${weatherEmoji} Accepted! Sold for $${price.toFixed(2)} (${gameState.richChocolate.isActive ? 'Rich' : 'Standard'}). Profit: $${profit.toFixed(2)}. (Chance: ${(chance * 100).toFixed(1)}%)`;
                logMessage(message, 'success');
            } else {
                gameState.rejectedOrders += 1;
                message = `${weatherEmoji} Rejected! Customer walked away. (Chance: ${(chance * 100).toFixed(1)}%)`;
                logMessage(message, 'error');
            }

            gameState.ordersRemaining -= 1;
            priceInput.value = price.toFixed(2); 

            updateUI();
            saveGame();

            gameState.isProcessing = false;
            document.getElementById('set-price-button').disabled = false;
        }

        // === Local Storage Functions ===

        async function saveGame() {
            // Remove functions (like isProcessing) that shouldn't be saved
            const saveState = JSON.parse(JSON.stringify(gameState));
            delete saveState.isProcessing;

            try {
                localStorage.setItem(GAME_DATA_KEY, JSON.stringify(saveState));
                // Add a small delay for the visual effect of "Saving..." during the day transition
                await new Promise(resolve => setTimeout(resolve, 500)); 
            } catch (error) {
                console.error("Error saving game state to localStorage:", error);
                logMessage("Error saving game state to local storage! Progress might be lost.", 'error');
            }
        }
        window.saveGame = saveGame;

        async function loadGame() {
            document.getElementById('status-message').textContent = 'Loading game...';

            try {
                const savedData = localStorage.getItem(GAME_DATA_KEY);

                if (savedData) {
                    const loadedData = JSON.parse(savedData);
                    // Merge loaded data into gameState, ensuring new fields are handled
                    gameState = { ...DEFAULT_GAME_STATE, ...loadedData };
                    
                    // Ensure richChocolate and upgrades exist for backward compatibility
                    gameState.upgrades = gameState.upgrades || DEFAULT_GAME_STATE.upgrades;
                    gameState.richChocolate = gameState.richChocolate || DEFAULT_GAME_STATE.richChocolate;

                    logMessage(`Game loaded successfully from local storage! Welcome back to Day ${gameState.day}.`, 'info');
                } else {
                    logMessage("No saved game found. Starting a new game.", 'info');
                }

                document.getElementById('status-message').textContent = 'Ready!';

                if (gameState.day === 0) {
                    startNewDayLogic(); // Start day 1
                } else {
                    updateUI(); // Display the loaded day
                }

            } catch (error) {
                console.error("Error loading game state from localStorage:", error);
                document.getElementById('status-message').textContent = 'Error loading game. Check console.';
                startNewDayLogic(); // Start new game on error
            }
        }
        window.loadGame = loadGame;

        // Initialize on window load
        window.onload = () => {
            window.loadSettings(); 
            window.loadGame(); // Start game logic

            document.getElementById('set-price-button').addEventListener('click', handlePriceSetting);
            document.getElementById('end-day-button').addEventListener('click', startNewDay); 
            document.getElementById('rich-chocolate-toggle').addEventListener('change', toggleRichChocolate);

            // TTS Listener for the main prompt
            document.getElementById('prompt-tts').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                const prompt = gameState.richChocolate.isActive ? CUSTOMER_PROMPT_RICH : CUSTOMER_PROMPT_STANDARD;
                window.speakText(prompt); 
            });


            // Modal listeners
            document.getElementById('settings-button').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('hidden'));
            document.getElementById('close-settings-button').addEventListener('click', () => document.getElementById('settings-modal').classList.add('hidden'));
            document.getElementById('dark-mode-toggle').addEventListener('change', toggleDarkMode);
            
            document.getElementById('upgrades-button').addEventListener('click', renderUpgradesModal);
            document.getElementById('close-upgrades-modal').addEventListener('click', () => document.getElementById('upgrades-modal').classList.add('hidden'));

            // User ID Display is now unnecessary since we are not using Firebase auth/multi-user data
            document.getElementById('user-id-display-container').classList.add('hidden');
        };
    </script>
</head>
<body class="p-4 sm:p-8 container mx-auto">

    <div class="max-w-4xl mx-auto relative">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-pink-700 dark:text-pink-300">üç´ Chocolate Stand Tycoon üí∞</h1>
            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <!-- Upgrades Button -->
                <button id="upgrades-button" class="text-gray-500 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition" aria-label="Open Upgrades">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 14V8m-4 4h8"/></svg>
                </button>
                <!-- Settings Button -->
                <button id="settings-button" class="text-gray-500 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 transition" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <p id="status-message" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4">Ready!</p>

        <!-- Stats Panel -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="p-4 chocolate-card rounded-xl text-center bg-pink-50 dark:bg-gray-700 dark:border-pink-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Day</p>
                <p id="day-display" class="text-3xl font-bold text-pink-600 dark:text-pink-300">0</p>
            </div>
            <div class="p-4 chocolate-card rounded-xl text-center bg-green-50 dark:bg-gray-700 dark:border-pink-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Money</p>
                <p class="text-3xl font-bold text-green-600 dark:text-green-400">$<span id="money-display">100.00</span></p>
            </div>
            <div class="p-4 chocolate-card rounded-xl text-center bg-yellow-50 dark:bg-gray-700 dark:border-pink-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Orders Today</p>
                <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">
                    <span id="orders-remaining">0</span>/<span id="total-orders">0</span>
                </p>
            </div>
            <div class="p-4 chocolate-card rounded-xl text-center col-span-2 md:col-span-1 bg-blue-50 dark:bg-gray-700 dark:border-pink-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Weather</p>
                <p id="weather-display" class="text-3xl font-bold text-blue-600 dark:text-blue-400">‚òÄÔ∏è Sunny</p>
            </div>
            <div class="p-4 chocolate-card rounded-xl text-left bg-gray-50 dark:bg-gray-700 dark:border-pink-500 col-span-2 md:col-span-4">
                <p id="weather-info" class="text-sm text-gray-600 dark:text-gray-300">Weather message will appear here.</p>
            </div>
        </div>

        <!-- Main Interaction Area -->
        <div id="interaction-area" class="chocolate-card p-6 rounded-xl mb-8 hidden">
            <!-- Chocolate Type Toggle -->
            <div class="flex justify-between items-center py-2 mb-4 bg-gray-50 dark:bg-gray-600 p-3 rounded-lg">
                <div class="flex items-center space-x-2">
                    <span class="text-xl" role="img" aria-label="Chocolate bar">üç´</span>
                    <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">Use Rich Chocolate?</span>
                    <p id="price-info" class="text-xs text-gray-500 dark:text-gray-400 ml-3">Cost per bar: $1.50</p>
                </div>
                <label for="rich-chocolate-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                    <input type="checkbox" id="rich-chocolate-toggle" class="rich-chocolate-toggle absolute w-full h-full opacity-0">
                    <span class="toggle-label absolute inset-0 bg-gray-300 rounded-full transition duration-300 ease-in-out">
                        <span class="toggle-checkbox absolute w-4 h-4 bg-white rounded-full transition duration-300 ease-in-out transform translate-x-1 translate-y-1 shadow-md border-2 border-gray-300"></span>
                    </span>
                </label>
            </div>


            <div class="flex items-start mb-4">
                <p id="prompt-text" class="text-xl font-semibold text-gray-800 dark:text-gray-200">A customer approaches. What price will you set for a single chocolate bar?</p>
                <button id="prompt-tts" class="ml-2 focus:outline-none text-pink-600 dark:text-pink-300 hover:scale-110 transition" aria-label="Read prompt aloud">
                    <span class="text-2xl" role="img" aria-label="Speaker icon">üîä</span>
                </button>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <input
                    type="number"
                    id="price-input"
                    placeholder="Price (e.g., 2.50)"
                    class="flex-grow p-3 border-2 border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 dark:bg-gray-600 dark:text-white dark:border-gray-500"
                    step="0.01"
                    min="0.01"
                    value="2.50"
                >
                <button
                    id="set-price-button"
                    class="flex items-center justify-center bg-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-700 transition duration-150 shadow-lg shadow-pink-300 active:shadow-none active:translate-y-0.5 disabled:opacity-50 dark:bg-pink-700 dark:hover:bg-pink-800 dark:shadow-pink-500/50"
                >
                    Set Price
                </button>
            </div>
        </div>

        <!-- End Day Button (Hidden initially) -->
        <div class="text-center">
            <button
                id="end-day-button"
                class="flex items-center justify-center mx-auto bg-purple-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-purple-700 transition duration-150 shadow-xl shadow-purple-300 active:shadow-none active:translate-y-0.5 hidden dark:bg-purple-700 dark:hover:bg-purple-800 dark:shadow-purple-500/50"
            >
                Go to Bed
            </button>
        </div>


        <!-- Game Log -->
        <div class="chocolate-card p-4 rounded-xl mt-8">
            <h2 class="text-2xl font-semibold text-pink-700 dark:text-pink-300 border-b pb-2 mb-2 dark:border-gray-600">Game Log</h2>
            <div id="log-area" class="h-48 overflow-y-auto text-sm dark:text-gray-300" style="max-height: 200px;">
                <!-- Log entries will be added here -->
            </div>
        </div>

        <!-- User ID Display (Hidden since Firestore is removed) -->
        <div id="user-id-display-container" class="mt-4 text-center text-xs text-gray-400 dark:text-gray-500">
            Game state saved locally in your browser storage.
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="chocolate-card w-full max-w-md p-6 rounded-xl dark:bg-gray-800 dark:text-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-pink-700 dark:text-pink-300">Settings</h3>
                <button id="close-settings-button" class="text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="flex justify-between items-center py-3 border-b dark:border-gray-700">
                <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                <label for="dark-mode-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                    <input type="checkbox" id="dark-mode-toggle" class="absolute w-full h-full opacity-0">
                    <span class="toggle-label absolute inset-0 bg-gray-300 rounded-full transition duration-300 ease-in-out"></span>
                    <span class="toggle-checkbox absolute w-4 h-4 bg-white rounded-full transition duration-300 ease-in-out transform translate-x-1 translate-y-1 shadow-md border-2 border-gray-300"></span>
                </label>
            </div>
            
        </div>
    </div>

    <!-- Upgrades Modal -->
    <div id="upgrades-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="chocolate-card w-full max-w-2xl p-6 rounded-xl dark:bg-gray-800 dark:text-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-pink-700 dark:text-pink-300">Business Upgrades</h3>
                <button id="close-upgrades-modal" class="text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Invest in these upgrades to permanently increase your customer flow and total daily orders.</p>

            <div id="upgrades-list" class="space-y-4">
                <!-- Upgrades will be rendered here dynamically -->
            </div>
        </div>
    </div>

    <!-- Day Transition Overlay (Full Screen Dark/Saving Animation) -->
    <div id="day-transition-overlay" class="fixed inset-0 z-[100] transition-opacity duration-[5000ms] ease-in-out pointer-events-none flex items-center justify-center">
        <!-- Content in the center -->
        <div class="text-white flex flex-col items-center">
            <div class="saving-spinner border-4 border-t-4 border-gray-200 border-t-pink-500 rounded-full w-12 h-12 mb-4"></div>
            <p class="text-lg font-semibold">Tucking in for the night...</p>
            <p class="text-sm">Saving progress to local storage...</p>
        </div>
    </div>

</body>
</html>
