<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>choco v8
    </title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Define CSS Variables for dynamic styling */
        :root {
            /* These will be set dynamically by JavaScript based on accentColor */
            --primary-color: #db2777; /* Default: Tailwind Pink-600 */
            --primary-color-dark: #f472b6; /* Default: Tailwind Pink-400 */
            --secondary-color: #be185d; /* Default: Tailwind Pink-700 */
            --secondary-color-dark: #9d174d; /* Default: Tailwind Pink-800 */

            /* This will be set dynamically based on borderRadius */
            --border-radius-size: 0.75rem; /* Default: rounded-xl */

            /* Main background colors */
            --bg-light: #fce7f3; /* Light pink/chocolate background */
            --bg-dark: #1f2937;  /* Dark gray for dark mode */
        }
        
        /* Custom styles using CSS variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            transition: background-color 0.3s, margin 0.3s;
        }
        body.dark {
            background-color: var(--bg-dark);
        }
        
        /* Layout mode: Compact */
        body.compact {
            padding: 0.5rem; /* Smaller padding */
        }
        .compact .chocolate-card {
            padding: 1rem !important; /* Smaller card padding */
            margin-bottom: 0.75rem !important;
        }
        .compact .grid > div {
            padding: 0.75rem !important; /* Smaller stat card padding */
        }

        .container {
            min-height: 100vh;
        }
        .chocolate-card {
            background-color: #ffffff;
            /* Use variables for border and rounding */
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius-size);
            box-shadow: 0 10px 15px -3px rgba(var(--secondary-color), 0.3), 0 4px 6px -2px rgba(var(--secondary-color), 0.1);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s, border-radius 0.3s;
        }
        .dark .chocolate-card {
            background-color: #374151; /* Dark card background */
            border-color: var(--secondary-color-dark); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            color: #d1d5db; /* Light text */
        }
        
        /* Custom scrollbar for log */
        #log-area::-webkit-scrollbar {
            width: 6px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .dark #log-area::-webkit-scrollbar-thumb {
            background: var(--secondary-color-dark);
        }

        /* Action Button Styles */
        .action-btn {
            background-color: var(--primary-color);
            transition: background-color 0.15s, transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 6px -1px rgba(var(--primary-color-rgb), 0.3);
        }
        .action-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
        }
        .action-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: none;
        }
        .dark .action-btn {
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        
        /* Day Transition Overlay Styles */
        #day-transition-overlay {
            background-color: rgba(0, 0, 0, 1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 5.0s ease-in-out; 
        }
        #day-transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .saving-spinner {
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color-dark); /* Dynamic spinner color */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dark Mode Toggle Switch CSS */
        .toggle-label {
            @apply bg-gray-300 dark:bg-gray-600;
        }
        .toggle-checkbox {
            @apply bg-white dark:bg-gray-400;
        }
        input:checked + .toggle-label {
            @apply bg-green-500 dark:bg-green-600;
        }
        input:checked ~ .toggle-checkbox {
            transform: translateX(20px) translateY(1px);
        }
    </style>
    
    <!-- The main game script -->
    <script>
        // Game Constants
        const ITEM_CONFIG = {
            'Milk Chocolate': { emoji: 'ü•õüç´', cost: 1.50, priceMaxBonus: 0.00 },
            'Dark Chocolate': { emoji: 'üåëüç´', cost: 1.75, priceMaxBonus: 0.50 },
            'White Chocolate': { emoji: '‚ö™üç´', cost: 1.60, priceMaxBonus: 0.20 },
            'Rich Chocolate': { emoji: 'üëëüç´', cost: 2.25, priceMaxBonus: 2.00 },
            'Water': { emoji: 'üíß', cost: 0.50, priceMaxBonus: 1.00 } // Water has low cost, high demand bonus in heat
        };

        const BASE_MAX_ORDERS = 10;
        const BASE_MAX_ACCEPTABLE_PRICE = 10.00; 
        const CUSTOMER_COOLDOWN_MS = 1500; 

        // --- New Customer Attitude Constants (Expanded) ---
        const CUSTOMER_TYPES = {
            // Original
            'Standard Joe': { emoji: 'üö∂', multiplier: 1.0, description: 'An average customer. Price sensitive, but reasonable.' },
            'Bargain Hunter': { emoji: 'üìâ', multiplier: 0.8, description: 'Only buys if the price is low. Very sensitive to price changes.' },
            'Loyalist': { emoji: 'üëë', multiplier: 1.2, description: 'Loves your chocolate and is willing to pay a premium.' },
            'Rich Tourist': { emoji: 'üí∏', multiplier: 1.5, description: 'Doesn\'t check the price tag. Very profitable.' },
            'Indecisive Kid': { emoji: 'ü§îüë∂', multiplier: 0.7, description: 'Poor but cute. Will waste time deciding after the transaction.' },
            
            // New, more complex attitudes
            'Budget Student': { emoji: 'üìö', multiplier: 0.85, description: 'Slightly above a Bargain Hunter. Needs an affordable treat.' },
            'Impulse Buyer': { emoji: 'üõçÔ∏è', multiplier: 1.35, description: 'Buys on a whim. Less likely to care about price.' },
            'Local Regular': { emoji: 'üè°', multiplier: 1.05, description: 'A reliable repeat customer. Slight loyalty bonus.' },
            'Gourmet Critic': { emoji: 'üßê', multiplier: 1.15, description: 'Pays a premium for perceived quality, but highly critical if disappointed.' },
            'Grumpy Commuter': { emoji: 'üò†', multiplier: 0.9, description: 'Wants their fix fast and cheap. Highly sensitive to any price increase.' },
            'Birthday Planner': { emoji: 'üéÇ', multiplier: 1.4, description: 'Buying a large batch for an event. Very high spending tolerance.' },
            // FIX: Changed outer quotes to double quotes to handle internal single quote (it's) correctly.
            'Social Media Influencer': { emoji: 'ü§≥', multiplier: 1.0, description: "Value conscious for status, but will pay average price if it's 'cool'." },
            'Office Supply Runner': { emoji: 'üì¶', multiplier: 1.1, description: 'Buying on a company card. Higher tolerance, but not excessively so.' },
        };
        const INDECISIVE_KID_CHANCE = 0.15; // 15% chance to encounter an indecisive kid
        const INDECISIVE_KID_DELAY_MS = 3000; // Extra 3 seconds delay

        const UPGRADE_CONFIG = {
            BANNER_1: { key: 'BANNER_1', name: "Small Banner Ad", cost: 150.00, orderIncrease: 5, description: "A simple banner to catch local attention." },
            BANNER_2: { key: 'BANNER_2', name: "Large Digital Sign", cost: 400.00, orderIncrease: 10, description: "A dazzling sign attracting customers from afar." },
            TIKTOK_PAGE: { key: 'TIKTOK_PAGE', name: "Launch TikTok Page", cost: 800.00, orderIncrease: 15, description: "Go viral! Massive reach and high customer hype." },
        };

        // Default Game State Variables
        const DEFAULT_GAME_STATE = {
            money: 100.00,
            day: 0,
            weather: 'Sunny',
            totalOrders: 0,
            ordersRemaining: 0,
            acceptedOrders: 0,
            rejectedOrders: 0,
            isProcessing: false, 
            upgrades: {
                bannerLevel: 0, 
                tiktokPage: false,
            },
            currentCustomer: {
                request: null, // The item the customer *wants*
                priceBase: BASE_MAX_ACCEPTABLE_PRICE, // Base price customer is willing to pay
                type: null, // New: The type of customer
            },
            lastChoice: null, // The item the player chose
        };

        // --- Styling Constants ---
        const COLOR_MAP = {
            'pink': {
                primary: 'pink-600', primaryDark: 'pink-400', 
                secondary: 'pink-700', secondaryDark: 'pink-800', 
                base: 'pink'
            },
            'teal': {
                primary: 'teal-600', primaryDark: 'teal-400', 
                secondary: 'teal-700', secondaryDark: 'teal-800', 
                base: 'teal'
            },
            'amber': {
                primary: 'amber-600', primaryDark: 'amber-400', 
                secondary: 'amber-700', secondaryDark: 'amber-800', 
                base: 'amber'
            },
            'indigo': {
                primary: 'indigo-600', primaryDark: 'indigo-400', 
                secondary: 'indigo-700', secondaryDark: 'indigo-800', 
                base: 'indigo'
            },
        };

        const ROUNDING_MAP = {
            'sharp': { class: 'rounded-none', cssVar: '0rem' },
            'default': { class: 'rounded-xl', cssVar: '0.75rem' },
            'pill': { class: 'rounded-full', cssVar: '9999px' },
        };

        let gameState = { ...DEFAULT_GAME_STATE };

        let settingsState = {
            isDarkMode: false,
            accentColor: 'pink', // Default color
            borderRadius: 'default', // Default rounding
            layoutMode: 'default', // Default layout
        };

        // Local Storage Keys
        const GAME_DATA_KEY = 'cs_tycoon_game_data_v8'; // Updated key for new version
        const SETTINGS_KEY = 'cs_tycoon_settings_v8'; // Updated key for new version

        const WEATHER_EFFECTS = {
            'Sunny': { effect: 1.2, emoji: '‚òÄÔ∏è', message: 'Perfect weather! High demand for cold drinks and treats.' },
            'Cloudy': { effect: 1.0, emoji: '‚òÅÔ∏è', message: 'Average day. Business as usual.' },
            'Rainy': { effect: 0.8, emoji: 'üåßÔ∏è', message: 'Gloomy day. Lower foot traffic, but high demand for comfort food (Dark/Rich Choco).' },
            'Heatwave': { effect: 0.6, emoji: 'üî•', message: 'It\'s melting! Price must be low or they won\'t risk it. WATER is very popular.' },
            'Snowing': { effect: 1.5, emoji: '‚ùÑÔ∏è', message: 'Cold weather brings high demand for hot chocolate ingredients (Milk/Rich Choco).' }
        };

        const CUSTOMER_PROMPT = "What price will you set for a single item?";
        
        // --- Tone.js Sound Initialization ---
        const successSynth = new Tone.Synth({
            oscillator: { type: "square" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.2 },
        }).toDestination();
        
        const rejectSynth = new Tone.MetalSynth({
            frequency: 100,
            envelope: { attack: 0.001, decay: 0.2, release: 0.1 },
            harmonicity: 3.1,
            modulationIndex: 10,
            resonance: 800,
            octaves: 1.5
        }).toDestination();
        
        /**
         * Schedule notes using Tone.now() plus an offset to prevent the "Start time must be strictly greater" error.
         */
        function playSuccessSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            const now = Tone.now();
            successSynth.triggerAttackRelease("C5", "8n", now);
            successSynth.triggerAttackRelease("E5", "8n", now + 0.1); // 100ms later
            successSynth.triggerAttackRelease("G5", "8n", now + 0.2); // 200ms later
        }

        /**
         * Schedule notes using Tone.now() plus an offset to prevent the "Start time must be strictly greater" error.
         */
        function playRejectSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            const now = Tone.now();
            rejectSynth.triggerAttackRelease("G3", "16n", now, 0.5);
            rejectSynth.triggerAttackRelease("C#3", "16n", now + 0.1, 0.5); // 100ms later
        }

        // --- Utility function for TTS (Removed per user request) ---
        async function speakText(text) {
             // TTS functionality removed
        }
        window.speakText = speakText; 

        // --- Styling Functions (Crucial for customization) ---

        /**
         * Converts a Tailwind color/shade string (e.g., 'pink-600') to its hex value.
         * Also sets the RGB variable for button shadows.
         */
        function getHexColor(colorClass) {
            const hexMap = {
                'pink-600': { hex: '#db2777', rgb: '219, 39, 119' }, 
                'pink-700': { hex: '#be185d', rgb: '190, 24, 93' }, 
                'pink-400': { hex: '#f472b6', rgb: '244, 114, 182' }, 
                'pink-800': { hex: '#9d174d', rgb: '157, 23, 77' },

                'teal-600': { hex: '#0d9488', rgb: '13, 148, 136' }, 
                'teal-700': { hex: '#0f766e', rgb: '15, 118, 110' }, 
                'teal-400': { hex: '#2dd4bf', rgb: '45, 212, 191' }, 
                'teal-800': { hex: '#0e7490', rgb: '14, 116, 144' },

                'amber-600': { hex: '#f59e0b', rgb: '245, 158, 11' }, 
                'amber-700': { hex: '#d97706', rgb: '217, 119, 6' }, 
                'amber-400': { hex: '#fbbf24', rgb: '251, 191, 36' }, 
                'amber-800': { hex: '#b45309', rgb: '180, 83, 9' },

                'indigo-600': { hex: '#4f46e5', rgb: '79, 70, 229' }, 
                'indigo-700': { hex: '#4338ca', rgb: '67, 56, 202' }, 
                'indigo-400': { hex: '#818cf8', rgb: '129, 140, 248' }, 
                'indigo-800': { hex: '#3730a3', rgb: '55, 48, 163' },

                'green-600': { hex: '#16a34a', rgb: '22, 163, 74' }, 
                'green-400': { hex: '#4ade80', rgb: '74, 222, 128' },
                'red-600': { hex: '#dc2626', rgb: '220, 38, 38' }, 
                'red-400': { hex: '#f87171', rgb: '248, 113, 113' },
                'yellow-600': { hex: '#ca8a04', rgb: '202, 138, 4' }, 
                'yellow-400': { hex: '#facc15', rgb: '250, 204, 21' },
                'purple-600': { hex: '#9333ea', rgb: '147, 51, 234' }, 
                'purple-700': { hex: '#7e22ce', rgb: '126, 34, 206' }, 
                'purple-800': { hex: '#6b21a8', rgb: '107, 33, 168' }
            };
            return hexMap[colorClass] || { hex: '#db2777', rgb: '219, 39, 119' }; // Fallback to pink-600
        }


        function applyStyle() {
            const root = document.documentElement;
            const body = document.body;
            const color = COLOR_MAP[settingsState.accentColor];
            const rounding = ROUNDING_MAP[settingsState.borderRadius];

            // 1. Apply Dark Mode Class
            if (settingsState.isDarkMode) {
                root.classList.add('dark');
                body.classList.add('dark');
                document.getElementById('dark-mode-toggle').checked = true;
            } else {
                root.classList.remove('dark');
                body.classList.remove('dark');
                document.getElementById('dark-mode-toggle').checked = false;
            }

            // 2. Apply Accent Color CSS Variables
            const primary = getHexColor(color.primary);
            const primaryDark = getHexColor(color.primaryDark);
            const secondary = getHexColor(color.secondary);
            const secondaryDark = getHexColor(color.secondaryDark);
            
            root.style.setProperty('--primary-color', primary.hex);
            root.style.setProperty('--primary-color-dark', primaryDark.hex);
            root.style.setProperty('--secondary-color', secondary.hex);
            root.style.setProperty('--secondary-color-dark', secondaryDark.hex);
            root.style.setProperty('--primary-color-rgb', primary.rgb); // For button shadows

            // 3. Apply Rounding CSS Variable
            root.style.setProperty('--border-radius-size', rounding.cssVar);

            // 4. Apply Layout Mode Class
            if (settingsState.layoutMode === 'compact') {
                body.classList.add('compact');
            } else {
                body.classList.remove('compact');
            }

            // 5. Update Dynamic Elements
            updateDynamicElements(); 
        }
        window.applyStyle = applyStyle;

        // Function to update elements that need specific color classes applied directly
        function updateDynamicElements() {
            const color = COLOR_MAP[settingsState.accentColor];
            const colorBase = color.base;

            // List of all possible text color classes to remove 
            const allColorTextClasses = [
                'text-pink-700', 'dark:text-pink-300', 'text-teal-700', 'dark:text-teal-300', 
                'text-amber-700', 'dark:text-amber-300', 'text-indigo-700', 'dark:text-indigo-300',
                'text-pink-600', 'dark:text-pink-400', 'text-teal-600', 'dark:text-teal-400', 
                'text-amber-600', 'dark:text-amber-400', 'text-indigo-600', 'dark:text-indigo-400',
            ];
            
            // Helper to clean and add classes
            const updateClasses = (element, classes) => {
                if (element) {
                    element.classList.remove(...allColorTextClasses);
                    classes.forEach(cls => element.classList.add(cls));
                }
            };

            // 1. Title Color
            const title = document.querySelector('h1');
            updateClasses(title, [`text-${colorBase}-700`, `dark:text-${colorBase}-300`]);
            title.className = `text-3xl sm:text-4xl font-extrabold ${Array.from(title.classList).join(' ')}`; 

            // 2. Game Log title color
            const logTitle = document.querySelector('.chocolate-card h2');
            updateClasses(logTitle, [`text-${colorBase}-700`, `dark:text-${colorBase}-300`]);
            
            // 3. Modal Titles
            updateClasses(document.getElementById('settings-modal').querySelector('h3'), [`text-${colorBase}-700`, `dark:text-${colorBase}-300`]);
            updateClasses(document.getElementById('upgrades-modal').querySelector('h3'), [`text-${colorBase}-700`, `dark:text-${colorBase}-300`]);

            // 4. Input focus ring color 
            const priceInput = document.getElementById('price-input');
            priceInput.classList.forEach(cls => {
                if (cls.startsWith('border-') && cls.endsWith('-300')) priceInput.classList.remove(cls);
                if (cls.startsWith('focus:ring-') && cls.endsWith('-500')) priceInput.classList.remove(cls);
                if (cls.startsWith('focus:border-') && cls.endsWith('-500')) priceInput.classList.remove(cls);
            });
            priceInput.classList.add(`border-${colorBase}-300`, `focus:ring-${colorBase}-500`, `focus:border-${colorBase}-500`);

            // 5. Action buttons (to ensure initial coloring is right before CSS variables kick in)
            const actionButtons = document.querySelectorAll('.item-choice-btn');
            actionButtons.forEach(btn => {
                 btn.className = `item-choice-btn flex-grow action-btn text-white font-bold py-3 px-2 transition duration-150 shadow-lg shadow-${colorBase}-300 active:shadow-none active:translate-y-0.5 disabled:opacity-50 dark:shadow-gray-700`;
            });

        }
        window.updateDynamicElements = updateDynamicElements;


        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                if (storedSettings) {
                    const loaded = JSON.parse(storedSettings);
                    settingsState = { ...settingsState, ...loaded };
                }
            } catch (e) {
                console.error("Error loading settings from localStorage:", e);
            }
            applyStyle();
        }
        window.loadSettings = loadSettings;

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsState));
            } catch (e) {
                console.error("Error saving settings to localStorage:", e);
            }
        }

        function toggleDarkMode(value) {
            settingsState.isDarkMode = value;
            applyStyle();
            saveSettings();
        }
        window.toggleDarkMode = toggleDarkMode; 
        
        function changeAccentColor(color) {
            settingsState.accentColor = color;
            applyStyle();
            saveSettings();
        }
        window.changeAccentColor = changeAccentColor;

        function changeRounding(level) {
            settingsState.borderRadius = level;
            applyStyle();
            saveSettings();
        }
        window.changeRounding = changeRounding;

        function changeLayoutMode(mode) {
            settingsState.layoutMode = mode;
            applyStyle();
            saveSettings();
        }
        window.changeLayoutMode = changeLayoutMode;


        function updateUI() {
            document.getElementById('day-display').textContent = gameState.day;
            document.getElementById('money-display').textContent = gameState.money.toFixed(2);
            document.getElementById('orders-remaining').textContent = gameState.ordersRemaining;
            document.getElementById('total-orders').textContent = gameState.totalOrders;
            document.getElementById('weather-display').innerHTML = `${WEATHER_EFFECTS[gameState.weather].emoji} ${gameState.weather}`;
            document.getElementById('weather-info').textContent = WEATHER_EFFECTS[gameState.weather].message;

            const interactionArea = document.getElementById('interaction-area');
            const endDayBtn = document.getElementById('end-day-button');
            const customerRequestDisplay = document.getElementById('customer-request');
            const customerTypeInfoDisplay = document.getElementById('customer-type-info');
            const customerEmojiDisplay = document.getElementById('customer-emoji');

            // Hide/Show main interaction elements
            if (gameState.ordersRemaining > 0) {
                endDayBtn.classList.add('hidden');
                interactionArea.classList.remove('hidden');

                const currentCustomer = gameState.currentCustomer;
                const customerTypeConfig = CUSTOMER_TYPES[currentCustomer.type] || CUSTOMER_TYPES['Standard Joe'];

                if (currentCustomer.request && currentCustomer.type) {
                    customerEmojiDisplay.textContent = customerTypeConfig.emoji;
                    customerRequestDisplay.textContent = `${currentCustomer.request}`;
                    customerTypeInfoDisplay.innerHTML = `
                        <span class="font-bold">${customerTypeConfig.name}:</span> 
                        <span class="text-xs font-medium">${customerTypeConfig.description}</span>
                    `;
                } else {
                    customerEmojiDisplay.textContent = 'üßë';
                    customerRequestDisplay.textContent = 'Preparing next customer...';
                    customerTypeInfoDisplay.textContent = '';
                }
                
                if (!gameState.isProcessing) {
                    document.getElementById('acceptance-feedback').innerHTML = '';
                    // Reset selected item appearance
                    document.querySelectorAll('.item-choice-btn').forEach(btn => btn.style.border = 'none');
                }

                document.getElementById('prompt-text').textContent = CUSTOMER_PROMPT;
                
            } else {
                interactionArea.classList.add('hidden');
                endDayBtn.classList.remove('hidden');
                customerRequestDisplay.textContent = '';
                customerTypeInfoDisplay.textContent = '';
            }

            // Update item info tooltips
            const items = Object.keys(ITEM_CONFIG);
            items.forEach(itemName => {
                const item = ITEM_CONFIG[itemName];
                const btn = document.getElementById(`item-${itemName.replace(/\s/g, '-')}-btn`);
                if (btn) {
                    btn.setAttribute('title', `Cost: $${item.cost.toFixed(2)} | Max Price Bonus: $${item.priceMaxBonus.toFixed(2)}`);
                }
            });
            
            // Set price button state
            const setPriceBtn = document.getElementById('set-price-button');
            const itemSelected = !!gameState.lastChoice;
            setPriceBtn.disabled = gameState.isProcessing || !itemSelected;
            setPriceBtn.textContent = gameState.isProcessing ? 'Processing...' : (itemSelected ? `Sell ${ITEM_CONFIG[gameState.lastChoice].emoji}` : 'Select Item First');

            if (gameState.lastChoice) {
                 const item = ITEM_CONFIG[gameState.lastChoice];
                 document.getElementById('price-info').textContent = `Chosen Cost: $${item.cost.toFixed(2)}`;
            } else {
                 document.getElementById('price-info').textContent = `Choose an item below.`;
            }
        }

        function logMessage(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const logEntry = document.createElement('div');
            let colorClass = 'text-gray-700 dark:text-gray-300';

            if (type === 'success') {
                colorClass = 'text-green-600 dark:text-green-400';
            } else if (type === 'error') {
                colorClass = 'text-red-600 dark:text-red-400';
            } else if (type === 'warning') {
                colorClass = 'text-yellow-600 dark:text-yellow-400';
            }

            logEntry.className = `p-2 ${colorClass} border-b border-gray-100 dark:border-gray-700`;
            logEntry.textContent = message;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight; 
        }

        // === Upgrades Logic (No changes) ===

        function renderUpgradesModal() {
            const container = document.getElementById('upgrades-list');
            container.innerHTML = '';
            const upgrades = [UPGRADE_CONFIG.BANNER_1, UPGRADE_CONFIG.BANNER_2, UPGRADE_CONFIG.TIKTOK_PAGE];
            const color = COLOR_MAP[settingsState.accentColor];

            upgrades.forEach(config => {
                let isPurchased = false;
                let isDisabled = false;

                if (config.key.startsWith('BANNER')) {
                    const level = config.key.endsWith('1') ? 1 : 2;
                    isPurchased = gameState.upgrades.bannerLevel >= level;
                    if (level === 2 && gameState.upgrades.bannerLevel < 1) {
                        isDisabled = true;
                    } 
                } else if (config.key === 'TIKTOK_PAGE') {
                    isPurchased = gameState.upgrades.tiktokPage;
                }
                
                let statusText;
                if (isPurchased) {
                    statusText = `<span class="text-green-500 font-bold">OWNED</span>`;
                } else if (gameState.money < config.cost || isDisabled) {
                    statusText = `<span class="text-red-500 font-bold">Cost: $${config.cost.toFixed(2)}</span>`;
                    isDisabled = true;
                } else {
                    statusText = `<span class="text-${color.base}-500 font-bold">Cost: $${config.cost.toFixed(2)}</span>`;
                }

                const buttonClass = isPurchased ? 'bg-gray-400 cursor-not-allowed' : (isDisabled ? 'bg-gray-400 cursor-not-allowed' : `bg-${color.base}-600 hover:bg-${color.base}-700`);
                const buttonText = isPurchased ? 'Owned' : (isDisabled ? (config.key === 'BANNER_2' ? 'Requires Small Ad' : 'Locked') : 'Buy');

                container.innerHTML += `
                    <div class="p-4 chocolate-card flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0">
                        <div>
                            <p class="text-lg font-semibold dark:text-gray-200">${config.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${config.description}</p>
                            <p class="text-sm mt-1">${statusText}</p>
                        </div>
                        <button 
                            onclick="buyUpgrade('${config.key}')" 
                            class="w-full md:w-auto px-4 py-2 text-white font-bold transition duration-150 rounded-lg ${buttonClass}" 
                            ${isDisabled || isPurchased ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            document.getElementById('upgrades-modal').classList.remove('hidden');
        }
        window.renderUpgradesModal = renderUpgradesModal;


        function buyUpgrade(upgradeKey) {
            const config = UPGRADE_CONFIG[upgradeKey];
            if (!config) { logMessage("Error: Invalid upgrade key.", 'error'); return; }

            if (gameState.money < config.cost) {
                logMessage(`Cannot afford ${config.name}. Need $${config.cost.toFixed(2)}.`, 'error');
                return;
            }

            if (upgradeKey.startsWith('BANNER')) {
                const level = upgradeKey.endsWith('1') ? 1 : 2;
                if (gameState.upgrades.bannerLevel === level) { logMessage(`${config.name} already purchased!`, 'warning'); return; }
                if (level === 2 && gameState.upgrades.bannerLevel < 1) { logMessage("Must purchase Small Banner Ad first.", 'error'); return; }

                gameState.money -= config.cost;
                gameState.upgrades.bannerLevel = level;
                logMessage(`Purchased ${config.name}! Max daily orders increased by ${config.orderIncrease}.`, 'success');

            } else if (upgradeKey === 'TIKTOK_PAGE') {
                if (gameState.upgrades.tiktokPage) { logMessage("TikTok Page already launched!", 'warning'); return; }
                gameState.money -= config.cost;
                gameState.upgrades.tiktokPage = true;
                logMessage(`Launched TikTok Page! Max daily orders increased by ${config.orderIncrease} and customer hype is massive!`, 'success');
            }

            updateUI();
            saveGame();
            renderUpgradesModal();
        }
        window.buyUpgrade = buyUpgrade;


        // === Game Logic ===

        function selectItem(itemName) {
            if (gameState.isProcessing) return;

            gameState.lastChoice = itemName;
            const item = ITEM_CONFIG[itemName];
            const color = getHexColor(COLOR_MAP[settingsState.accentColor].primary).hex;

            // Highlight the selected button
            document.querySelectorAll('.item-choice-btn').forEach(btn => {
                btn.style.border = 'none';
            });
            document.getElementById(`item-${itemName.replace(/\s/g, '-')}-btn`).style.border = `4px solid ${color}`;
            
            // Clear feedback
            document.getElementById('acceptance-feedback').innerHTML = '';

            updateUI();
        }
        window.selectItem = selectItem;


        function generateCustomerRequest() {
            // 1. Determine Customer Type
            const types = Object.keys(CUSTOMER_TYPES);
            let customerTypeKey;
            
            // Check for Indecisive Kid event
            if (Math.random() < INDECISIVE_KID_CHANCE) {
                customerTypeKey = 'Indecisive Kid';
            } else {
                // Filter out the Indecisive Kid from standard random selection
                const standardTypes = types.filter(t => t !== 'Indecisive Kid');
                const typeIndex = Math.floor(Math.random() * standardTypes.length);
                customerTypeKey = standardTypes[typeIndex];
            }
            
            const customerType = CUSTOMER_TYPES[customerTypeKey];
            gameState.currentCustomer.type = customerTypeKey;


            // 2. Determine Item Request
            const items = Object.keys(ITEM_CONFIG);
            const requestIndex = Math.floor(Math.random() * items.length);
            const requestItem = items[requestIndex];

            // 3. Adjust base price willing to pay based on requested item and weather
            let basePrice = BASE_MAX_ACCEPTABLE_PRICE + ITEM_CONFIG[requestItem].priceMaxBonus;

            // Apply weather and item-specific bonuses
            if (gameState.weather === 'Heatwave' && requestItem === 'Water') {
                 basePrice *= 1.5; // Premium for cold drinks
            }
            
            if ((gameState.weather === 'Rainy' || gameState.weather === 'Snowing') && (requestItem === 'Dark Chocolate' || requestItem === 'Rich Chocolate')) {
                 basePrice *= 1.2;
            }

            gameState.currentCustomer.request = requestItem;
            gameState.currentCustomer.priceBase = basePrice;
            gameState.lastChoice = null; // Reset choice for new customer
        }

        function startNewDayLogic() {
            gameState.day += 1;
            gameState.acceptedOrders = 0;
            gameState.rejectedOrders = 0;

            if (gameState.day > 1) {
                logMessage(`--- END OF DAY ${gameState.day - 1} SUMMARY ---`, 'info');
            }

            const weatherKeys = Object.keys(WEATHER_EFFECTS);
            gameState.weather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];

            let maxBaseOrders = BASE_MAX_ORDERS;
            if (gameState.upgrades.bannerLevel >= 1) { maxBaseOrders += UPGRADE_CONFIG.BANNER_1.orderIncrease; }
            if (gameState.upgrades.bannerLevel >= 2) { maxBaseOrders += UPGRADE_CONFIG.BANNER_2.orderIncrease; }
            if (gameState.upgrades.tiktokPage) { maxBaseOrders += UPGRADE_CONFIG.TIKTOK_PAGE.orderIncrease; }

            const fluctuation = Math.floor(Math.random() * (maxBaseOrders / 2));
            gameState.totalOrders = Math.max(5, maxBaseOrders + fluctuation); 
            gameState.ordersRemaining = gameState.totalOrders;

            logMessage(`--- DAY ${gameState.day} BEGINS ---`, 'info');
            logMessage(`Weather is ${gameState.weather}. Max expected customers: ${gameState.totalOrders}.`, 'info');
            
            generateCustomerRequest();
            updateUI();
        }

        async function startNewDay() {
            if (gameState.isProcessing) return;
            gameState.isProcessing = true;
            
            const overlay = document.getElementById('day-transition-overlay');
            const endDayBtn = document.getElementById('end-day-button');

            endDayBtn.disabled = true;
            overlay.classList.add('active'); 

            await new Promise(resolve => setTimeout(resolve, 100)); 

            logMessage("Saving game state to local storage...", 'info');
            await saveGame();
            logMessage("Save successful.", 'info');
            
            await new Promise(resolve => setTimeout(resolve, 4900)); 
            
            startNewDayLogic();

            overlay.classList.remove('active');
            endDayBtn.disabled = false;
            gameState.isProcessing = false;
        }
        window.startNewDay = startNewDay;


        // Core Decision Logic
        function checkAcceptance(price, chosenItem) {
            const requestedItem = gameState.currentCustomer.request;
            const customerBasePrice = gameState.currentCustomer.priceBase;
            const chosenItemConfig = ITEM_CONFIG[chosenItem];
            const customerTypeConfig = CUSTOMER_TYPES[gameState.currentCustomer.type];

            // 1. Item Match Check (Crucial new difficulty)
            const isMatch = chosenItem === requestedItem;
            if (!isMatch) {
                return { accepts: false, isMatch: false, chance: 0, cost: chosenItemConfig.cost, maxAcceptable: 0 };
            }

            // 2. Price Check
            const costOfGoods = chosenItemConfig.cost;
            
            // Max acceptable price: Base * Weather Effect * Customer Type Multiplier (New)
            const maxAcceptablePrice = customerBasePrice * WEATHER_EFFECTS[gameState.weather].effect * customerTypeConfig.multiplier; 
            
            const priceRange = maxAcceptablePrice - costOfGoods;
            // Normalized price: 0 (cheap) to 1 (max acceptable). Can be > 1 if price is too high.
            const normalizedPrice = Math.max(0, price - costOfGoods) / priceRange;
            
            // Acceptance chance drops quadratically as price increases toward max acceptable.
            const baseChance = Math.max(0, 1 - Math.pow(normalizedPrice, 2.5));

            let finalChance = Math.min(1.0, baseChance);
            
            const roll = Math.random();

            return {
                accepts: roll < finalChance,
                isMatch: true,
                chance: finalChance,
                cost: costOfGoods,
                maxAcceptable: maxAcceptablePrice
            };
        }

        function handlePriceSetting() {
            if (gameState.isProcessing || !gameState.lastChoice) return;

            const priceInput = document.getElementById('price-input');
            const feedbackDiv = document.getElementById('acceptance-feedback');
            const price = parseFloat(priceInput.value);
            const chosenItem = gameState.lastChoice;

            if (isNaN(price) || price <= 0) {
                logMessage("Please enter a valid price greater than $0.", 'error');
                return;
            }

            gameState.isProcessing = true;
            // Disable interaction elements
            document.getElementById('set-price-button').disabled = true;
            priceInput.disabled = true;
            document.querySelectorAll('.item-choice-btn').forEach(btn => btn.disabled = true);


            const { accepts, isMatch, chance, cost, maxAcceptable } = checkAcceptance(price, chosenItem);
            const weatherEmoji = WEATHER_EFFECTS[gameState.weather].emoji;
            const color = COLOR_MAP[settingsState.accentColor];
            const customerTypeConfig = CUSTOMER_TYPES[gameState.currentCustomer.type];

            let message;
            let feedbackHtml;

            if (!isMatch) {
                playRejectSound();
                gameState.rejectedOrders += 1;
                message = `${weatherEmoji} Mistake! Customer requested ${ITEM_CONFIG[gameState.currentCustomer.request].emoji} but you offered ${ITEM_CONFIG[chosenItem].emoji}. Order cancelled.`;
                feedbackHtml = `
                    <p class="text-red-600 dark:text-red-400 font-bold text-lg">
                        ‚ùå MISMATCH!
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        They wanted ${ITEM_CONFIG[gameState.currentCustomer.request].emoji} but you offered ${ITEM_CONFIG[chosenItem].emoji}.
                    </p>
                `;
                logMessage(message, 'error');

            } else if (accepts) {
                playSuccessSound(); 
                const profit = price - cost;
                gameState.money += profit;
                gameState.acceptedOrders += 1;
                message = `${weatherEmoji} Accepted! Sold ${ITEM_CONFIG[chosenItem].emoji} to ${customerTypeConfig.name} for $${price.toFixed(2)}. Profit: $${profit.toFixed(2)}. (Chance: ${(chance * 100).toFixed(1)}%)`;
                
                feedbackHtml = `
                    <p class="text-green-600 dark:text-green-400 font-bold text-lg">
                        ‚úÖ ACCEPTED!
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Profit: $${profit.toFixed(2)} | Chance: ${(chance * 100).toFixed(1)}% 
                    </p>
                `;
                logMessage(message, 'success');
            } else {
                playRejectSound(); 
                gameState.rejectedOrders += 1;
                message = `${weatherEmoji} Rejected! Price $${price.toFixed(2)} was too high for ${ITEM_CONFIG[chosenItem].emoji} (Customer: ${customerTypeConfig.name}). (Chance: ${(chance * 100).toFixed(1)}%)`;
                
                feedbackHtml = `
                    <p class="text-red-600 dark:text-red-400 font-bold text-lg">
                        ‚ùå REJECTED
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Customer (${customerTypeConfig.name}) found price too high. 
                        <br>
                        Max Price they'd pay: ~$${maxAcceptable.toFixed(2)}.
                    </p>
                `;
                logMessage(message, 'error');
            }

            feedbackDiv.innerHTML = feedbackHtml; 

            gameState.ordersRemaining -= 1;
            priceInput.value = price.toFixed(2); 

            saveGame();

            if (gameState.ordersRemaining <= 0) {
                gameState.isProcessing = false;
                document.getElementById('set-price-button').disabled = false;
                priceInput.disabled = false;
                document.querySelectorAll('.item-choice-btn').forEach(btn => btn.disabled = false);
                updateUI();
                return;
            }
            
            // --- Indecisive Kid Delay Logic ---
            const isIndecisiveKid = gameState.currentCustomer.type === 'Indecisive Kid';
            const effectiveCooldown = isIndecisiveKid ? CUSTOMER_COOLDOWN_MS + INDECISIVE_KID_DELAY_MS : CUSTOMER_COOLDOWN_MS;

            if (isIndecisiveKid) {
                logMessage(`‚ö†Ô∏è Indecisive Kid Delay! Lost ${INDECISIVE_KID_DELAY_MS / 1000} seconds of selling time.`, 'warning');
                feedbackDiv.innerHTML += `
                    <p class="mt-1 text-sm text-yellow-500 dark:text-yellow-400 font-medium">
                        The kid is stuck deciding what to do with their chocolate... ${INDECISIVE_KID_DELAY_MS / 1000}s Delay!
                    </p>
                `;
            } else {
                feedbackDiv.innerHTML += `
                    <p class="mt-1 text-sm text-${color.base}-500 dark:text-${color.base}-400 font-medium animate-pulse">
                        Waiting for next customer...
                    </p>
                `;
            }

            // --- Use effectiveCooldown here ---
            setTimeout(() => {
                // Generate next customer's request
                generateCustomerRequest();

                document.getElementById('set-price-button').disabled = false;
                priceInput.disabled = false;
                document.querySelectorAll('.item-choice-btn').forEach(btn => btn.disabled = false);
                
                gameState.isProcessing = false;
                
                updateUI(); 
            }, effectiveCooldown); 

        }
        window.handlePriceSetting = handlePriceSetting;


        // === Local Storage Functions ===

        async function saveGame() {
            const saveState = JSON.parse(JSON.stringify(gameState));
            delete saveState.isProcessing;

            try {
                localStorage.setItem(GAME_DATA_KEY, JSON.stringify(saveState));
                await new Promise(resolve => setTimeout(resolve, 500)); 
            } catch (error) {
                console.error("Error saving game state to localStorage:", error);
                logMessage("Error saving game state to local storage! Progress might be lost.", 'error');
            }
        }
        window.saveGame = saveGame;

        async function loadGame() {
            document.getElementById('status-message').textContent = 'Loading game...';

            try {
                const savedData = localStorage.getItem(GAME_DATA_KEY);

                if (savedData) {
                    const loadedData = JSON.parse(savedData);
                    // Merge loaded data with defaults to ensure new fields (like currentCustomer.type) exist
                    gameState = { ...DEFAULT_GAME_STATE, ...loadedData };
                    
                    // Ensure nested objects exist
                    gameState.upgrades = gameState.upgrades || DEFAULT_GAME_STATE.upgrades;
                    gameState.currentCustomer = gameState.currentCustomer || DEFAULT_GAME_STATE.currentCustomer;

                    logMessage(`Game loaded successfully from local storage! Welcome back to Day ${gameState.day}.`, 'info');
                } else {
                    logMessage("No saved game found. Starting a new game.", 'info');
                }

                document.getElementById('status-message').textContent = 'Ready!';

                if (gameState.day === 0) {
                    startNewDayLogic(); // Start day 1 and generate first customer
                } else {
                    // If loading mid-day, make sure there's a current request
                    if (!gameState.currentCustomer.request && gameState.ordersRemaining > 0) {
                        generateCustomerRequest();
                    }
                    updateUI(); // Display the loaded day
                }

            } catch (error) {
                console.error("Error loading game state from localStorage:", error);
                document.getElementById('status-message').textContent = 'Error loading game. Check console.';
                startNewDayLogic(); // Start new game on error
            }
        }
        window.loadGame = loadGame;

        // Initialize on window load
        window.onload = () => {
            window.loadSettings(); 
            window.loadGame(); 

            // Initialize all input and select states in the modal based on loaded settings
            document.getElementById('accent-color-select').value = settingsState.accentColor;
            document.getElementById('border-rounding-select').value = settingsState.borderRadius;
            document.getElementById('layout-mode-select').value = settingsState.layoutMode;


            document.getElementById('set-price-button').addEventListener('click', handlePriceSetting);
            document.getElementById('end-day-button').addEventListener('click', startNewDay); 
            
            // Add listeners for the new item choice buttons
            Object.keys(ITEM_CONFIG).forEach(itemName => {
                const btn = document.getElementById(`item-${itemName.replace(/\s/g, '-')}-btn`);
                if (btn) {
                    btn.addEventListener('click', () => selectItem(itemName));
                }
            });


            // Modal listeners
            document.getElementById('settings-button').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('hidden'));
            document.getElementById('close-settings-button').addEventListener('click', () => document.getElementById('settings-modal').classList.add('hidden'));
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => toggleDarkMode(e.target.checked));
            document.getElementById('accent-color-select').addEventListener('change', (e) => changeAccentColor(e.target.value));
            document.getElementById('border-rounding-select').addEventListener('change', (e) => changeRounding(e.target.value));
            document.getElementById('layout-mode-select').addEventListener('change', (e) => changeLayoutMode(e.target.value));
            
            document.getElementById('upgrades-button').addEventListener('click', renderUpgradesModal);
            document.getElementById('close-upgrades-modal').addEventListener('click', () => document.getElementById('upgrades-modal').classList.add('hidden'));

            document.getElementById('user-id-display-container').classList.add('hidden');
        };
    </script>
</head>
<body class="p-4 sm:p-8 container mx-auto">

    <div class="max-w-4xl mx-auto relative">
        <div class="flex justify-between items-center mb-6">
            <!-- Dynamic Title Color -->
            <h1 class="text-3xl sm:text-4xl font-extrabold text-pink-700 dark:text-pink-300">üí∞ Chocolate Pricing Tycoon üìà</h1>
            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <!-- Upgrades Button -->
                <button id="upgrades-button" class="text-gray-500 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition" aria-label="Open Upgrades">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 14V8m-4 4h8"/></svg>
                </button>
                <!-- Settings Button -->
                <button id="settings-button" class="text-gray-500 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 transition" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <p id="status-message" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4">Ready!</p>

        <!-- Stats Panel -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="p-4 chocolate-card text-center bg-pink-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Day</p>
                <p id="day-display" class="text-3xl font-bold text-pink-600 dark:text-pink-300">0</p>
            </div>
            <div class="p-4 chocolate-card text-center bg-green-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Money</p>
                <p class="text-3xl font-bold text-green-600 dark:text-green-400">$<span id="money-display">100.00</span></p>
            </div>
            <div class="p-4 chocolate-card text-center bg-yellow-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Orders Today</p>
                <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">
                    <span id="orders-remaining">0</span>/<span id="total-orders">0</span>
                </p>
            </div>
            <div class="p-4 chocolate-card text-center col-span-2 md:col-span-1 bg-blue-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Weather</p>
                <p id="weather-display" class="text-3xl font-bold text-blue-600 dark:text-blue-400">‚òÄÔ∏è Sunny</p>
            </div>
            <div class="p-4 chocolate-card text-left bg-gray-50 dark:bg-gray-700 dark:border-gray-500 col-span-2 md:col-span-4">
                <p id="weather-info" class="text-sm text-gray-600 dark:text-gray-300">Weather message will appear here.</p>
            </div>
        </div>

        <!-- Main Interaction Area -->
        <div id="interaction-area" class="chocolate-card p-6 mb-8 hidden">
            <!-- Customer Request Display (Updated to include type) -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center py-2 mb-4 bg-gray-50 dark:bg-gray-600 p-3 rounded-lg">
                <div class="flex items-center space-x-2">
                    <span id="customer-emoji" class="text-xl" role="img" aria-label="Customer">üßë</span>
                    <span id="customer-request" class="text-lg font-semibold text-gray-800 dark:text-gray-200">Preparing next customer...</span>
                </div>
                <div id="customer-type-info" class="text-sm text-gray-600 dark:text-gray-400 mt-1 md:mt-0 md:text-right"></div>
            </div>

            <div class="flex items-start mb-4">
                <p id="prompt-text" class="text-xl font-semibold text-gray-800 dark:text-gray-200">What price will you set for a single item?</p>
            </div>
            
            <p id="price-info" class="text-sm text-gray-500 dark:text-gray-400 mb-3">Choose an item below.</p>


            <!-- Item Selection Buttons -->
            <div class="grid grid-cols-5 gap-2 mb-4">
                <!-- Buttons are dynamically colored using CSS variables set in applyStyle, class is .action-btn -->
                <button id="item-Milk-Chocolate-btn" class="item-choice-btn text-white font-bold py-3 px-2 transition duration-150 rounded-lg" title="Cost: $1.50 | Max Price Bonus: $0.00">ü•õüç´ Milk</button>
                <button id="item-Dark-Chocolate-btn" class="item-choice-btn text-white font-bold py-3 px-2 transition duration-150 rounded-lg" title="Cost: $1.75 | Max Price Bonus: $0.50">üåëüç´ Dark</button>
                <button id="item-White-Chocolate-btn" class="item-choice-btn text-white font-bold py-3 px-2 transition duration-150 rounded-lg" title="Cost: $1.60 | Max Price Bonus: $0.20">‚ö™üç´ White</button>
                <button id="item-Rich-Chocolate-btn" class="item-choice-btn text-white font-bold py-3 px-2 transition duration-150 rounded-lg" title="Cost: $2.25 | Max Price Bonus: $2.00">üëëüç´ Rich</button>
                <button id="item-Water-btn" class="item-choice-btn text-white font-bold py-3 px-2 transition duration-150 rounded-lg" title="Cost: $0.50 | Max Price Bonus: $1.00">üíß Water</button>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <!-- Price Input -->
                <input
                    type="number"
                    id="price-input"
                    placeholder="Price (e.g., 2.50)"
                    class="flex-grow p-3 border-2 border-pink-300 focus:ring-pink-500 focus:border-pink-500 transition duration-150 dark:bg-gray-600 dark:text-white dark:border-gray-500 disabled:opacity-75"
                    style="border-radius: var(--border-radius-size);"
                    step="0.01"
                    min="0.01"
                    value="2.50"
                >
                
                <!-- Acceptance Feedback Display -->
                <div id="acceptance-feedback" class="flex flex-col items-center justify-center min-w-[150px] h-full text-center p-2 bg-gray-100 dark:bg-gray-700 flex-shrink-0 order-first sm:order-none w-full sm:w-auto" style="border-radius: var(--border-radius-size);">
                    <!-- Feedback appears here -->
                </div>

                <!-- Set Price Button -->
                <button
                    id="set-price-button"
                    class="flex items-center justify-center bg-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-700 transition duration-150 shadow-lg shadow-pink-300 active:shadow-none active:translate-y-0.5 disabled:opacity-50 dark:bg-pink-700 dark:hover:bg-pink-800 dark:shadow-pink-500/50 w-full sm:w-auto"
                    disabled
                >
                    Select Item First
                </button>
            </div>
        </div>

        <!-- End Day Button (Hidden initially) -->
        <div class="text-center">
            <!-- End Day button uses a different purple color, keep it distinct -->
            <button
                id="end-day-button"
                class="flex items-center justify-center mx-auto bg-purple-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-purple-700 transition duration-150 shadow-xl shadow-purple-300 active:shadow-none active:translate-y-0.5 hidden dark:bg-purple-700 dark:hover:bg-purple-800 dark:shadow-purple-500/50"
                style="border-radius: var(--border-radius-size);"
            >
                Go to Bed
            </button>
        </div>


        <!-- Game Log -->
        <div class="chocolate-card p-4 mt-8">
            <!-- Dynamic Title Color -->
            <h2 class="text-2xl font-semibold text-pink-700 dark:text-pink-300 border-b pb-2 mb-2 dark:border-gray-600">Game Log</h2>
            <div id="log-area" class="h-48 overflow-y-auto text-sm dark:text-gray-300" style="max-height: 200px;">
                <!-- Log entries will be added here -->
            </div>
        </div>

        <!-- User ID Display (Hidden since local storage is used) -->
        <div id="user-id-display-container" class="mt-4 text-center text-xs text-gray-400 dark:text-gray-500">
            Game state saved locally in your browser storage.
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="chocolate-card w-full max-w-md p-6 dark:bg-gray-800 dark:text-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-pink-700 dark:text-pink-300">Settings</h3>
                <button id="close-settings-button" class="text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="space-y-4">
                <!-- 1. Dark Mode Toggle -->
                <div class="flex justify-between items-center py-3 border-b dark:border-gray-700">
                    <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                    <label for="dark-mode-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="absolute w-full h-full opacity-0">
                        <span class="toggle-label absolute inset-0 bg-gray-300 rounded-full transition duration-300 ease-in-out"></span>
                        <span class="toggle-checkbox absolute w-4 h-4 bg-white rounded-full transition duration-300 ease-in-out transform translate-x-1 translate-y-1 shadow-md border-2 border-gray-300"></span>
                    </label>
                </div>

                <!-- 2. Accent Color Select -->
                <div class="py-3 border-b dark:border-gray-700">
                    <label for="accent-color-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Accent Color</label>
                    <select id="accent-color-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <option value="pink">Pink (Sweet Berry)</option>
                        <option value="teal">Teal (Mint Chocolate)</option>
                        <option value="amber">Amber (Golden Wrapper)</option>
                        <option value="indigo">Indigo (Royal Delight)</option>
                    </select>
                </div>

                <!-- 3. Border Rounding Select -->
                <div class="py-3 border-b dark:border-gray-700">
                    <label for="border-rounding-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Border Rounding</label>
                    <select id="border-rounding-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <option value="sharp">Sharp (Modern/Boxy)</option>
                        <option value="default">Default (Rounded Edges)</option>
                        <option value="pill">Pill (Very Soft/Pill)</option>
                    </select>
                </div>

                <!-- 4. Layout Mode Select -->
                <div class="py-3">
                    <label for="layout-mode-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Layout Density</label>
                    <select id="layout-mode-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <option value="default">Default (Spacious)</option>
                        <option value="compact">Compact (Less Padding)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrades Modal -->
    <div id="upgrades-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="chocolate-card w-full max-w-2xl p-6 dark:bg-gray-800 dark:text-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-pink-700 dark:text-pink-300">Business Upgrades</h3>
                <button id="close-upgrades-modal" class="text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Invest in these upgrades to permanently increase your customer flow and total daily orders.</p>

            <div id="upgrades-list" class="space-y-4">
                <!-- Upgrades will be rendered here dynamically -->
            </div>
        </div>
    </div>

    <!-- Day Transition Overlay (Full Screen Dark/Saving Animation) -->
    <div id="day-transition-overlay" class="fixed inset-0 z-[100] transition-opacity duration-[5000ms] ease-in-out pointer-events-none flex items-center justify-center">
        <!-- Content in the center -->
        <div class="text-white flex flex-col items-center">
            <div class="saving-spinner border-4 border-t-4 border-gray-200 rounded-full w-12 h-12 mb-4"></div>
            <p class="text-lg font-semibold">Tucking in for the night...</p>
            <p class="text-sm">Saving progress to local storage...</p>
        </div>
    </div>

</body>
</html>
