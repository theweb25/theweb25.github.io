<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chocolate Stand Tycoon v5 (Customizable)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Define CSS Variables for dynamic styling */
        :root {
            /* These will be set dynamically by JavaScript based on accentColor */
            --primary-color: #db2777; /* Default: Tailwind Pink-600 */
            --primary-color-dark: #f472b6; /* Default: Tailwind Pink-400 */
            --secondary-color: #be185d; /* Default: Tailwind Pink-700 */
            --secondary-color-dark: #9d174d; /* Default: Tailwind Pink-800 */

            /* This will be set dynamically based on borderRadius */
            --border-radius-size: 0.75rem; /* Default: rounded-xl */

            /* Main background colors */
            --bg-light: #fce7f3; /* Light pink/chocolate background */
            --bg-dark: #1f2937;  /* Dark gray for dark mode */
        }
        
        /* Custom styles using CSS variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            transition: background-color 0.3s, margin 0.3s;
        }
        body.dark {
            background-color: var(--bg-dark);
        }
        
        /* Layout mode: Compact */
        body.compact {
            padding: 0.5rem; /* Smaller padding */
        }
        .compact .chocolate-card {
            padding: 1rem !important; /* Smaller card padding */
            margin-bottom: 0.75rem !important;
        }
        .compact .grid > div {
            padding: 0.75rem !important; /* Smaller stat card padding */
        }

        .container {
            min-height: 100vh;
        }
        .chocolate-card {
            background-color: #ffffff;
            /* Use variables for border and rounding */
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius-size);
            box-shadow: 0 10px 15px -3px rgba(var(--secondary-color), 0.3), 0 4px 6px -2px rgba(var(--secondary-color), 0.1);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s, border-radius 0.3s;
        }
        .dark .chocolate-card {
            background-color: #374151; /* Dark card background */
            border-color: var(--secondary-color-dark); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            color: #d1d5db; /* Light text */
        }
        
        /* Custom scrollbar for log */
        #log-area::-webkit-scrollbar {
            width: 6px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .dark #log-area::-webkit-scrollbar-thumb {
            background: var(--secondary-color-dark);
        }

        /* Toggle switch styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--secondary-color);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--secondary-color);
        }

        /* Rich Chocolate Toggle Specifics (override with dark brown) */
        .rich-chocolate-toggle:checked + .toggle-label {
            background-color: #5d2508 !important; /* Dark brown for rich chocolate */
        }
        .rich-chocolate-toggle:checked + .toggle-label .toggle-checkbox {
            background-color: #fca5a5 !important; /* Reddish white dot */
        }
        
        /* Day Transition Overlay Styles */
        #day-transition-overlay {
            background-color: rgba(0, 0, 0, 1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 5.0s ease-in-out; 
        }
        #day-transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .saving-spinner {
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color-dark); /* Dynamic spinner color */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <!-- The main game script -->
    <script>
        // Game Constants
        const BASE_COST_PER_BAR = 1.50;
        const RICH_CHOCOLATE_BONUS_COST = 0.75; 
        const RICH_CHOCOLATE_MAX_PRICE_BONUS = 2.00; 
        const BASE_MAX_ORDERS = 10;
        const BASE_MAX_ACCEPTABLE_PRICE = 10.00; 
        const CUSTOMER_COOLDOWN_MS = 1500; 

        const UPGRADE_CONFIG = {
            BANNER_1: { key: 'BANNER_1', name: "Small Banner Ad", cost: 150.00, orderIncrease: 5, description: "A simple banner to catch local attention." },
            BANNER_2: { key: 'BANNER_2', name: "Large Digital Sign", cost: 400.00, orderIncrease: 10, description: "A dazzling sign attracting customers from afar." },
            TIKTOK_PAGE: { key: 'TIKTOK_PAGE', name: "Launch TikTok Page", cost: 800.00, orderIncrease: 15, description: "Go viral! Massive reach and high customer hype." },
        };

        // Default Game State Variables
        const DEFAULT_GAME_STATE = {
            money: 100.00,
            day: 0,
            weather: 'Sunny',
            totalOrders: 0,
            ordersRemaining: 0,
            acceptedOrders: 0,
            rejectedOrders: 0,
            isProcessing: false, 
            upgrades: {
                bannerLevel: 0, 
                tiktokPage: false,
            },
            richChocolate: {
                isActive: false, 
            }
        };

        // --- New Styling Constants ---
        const COLOR_MAP = {
            'pink': {
                primary: 'pink-600', primaryDark: 'pink-400', 
                secondary: 'pink-700', secondaryDark: 'pink-800', 
                base: 'pink'
            },
            'teal': {
                primary: 'teal-600', primaryDark: 'teal-400', 
                secondary: 'teal-700', secondaryDark: 'teal-800', 
                base: 'teal'
            },
            'amber': {
                primary: 'amber-600', primaryDark: 'amber-400', 
                secondary: 'amber-700', secondaryDark: 'amber-800', 
                base: 'amber'
            },
            'indigo': {
                primary: 'indigo-600', primaryDark: 'indigo-400', 
                secondary: 'indigo-700', secondaryDark: 'indigo-800', 
                base: 'indigo'
            },
        };

        const ROUNDING_MAP = {
            'sharp': { class: 'rounded-none', cssVar: '0rem' },
            'default': { class: 'rounded-xl', cssVar: '0.75rem' },
            'pill': { class: 'rounded-full', cssVar: '9999px' },
        };

        let gameState = { ...DEFAULT_GAME_STATE };

        let settingsState = {
            isDarkMode: false,
            accentColor: 'pink', // Default color
            borderRadius: 'default', // Default rounding
            layoutMode: 'default', // Default layout
        };

        // Local Storage Keys
        const GAME_DATA_KEY = 'cs_tycoon_game_data_v5'; 
        const SETTINGS_KEY = 'cs_tycoon_settings_v5';

        const WEATHER_EFFECTS = {
            'Sunny': { effect: 1.2, emoji: '‚òÄÔ∏è', message: 'Perfect weather! Customers are thirsty for chocolate.' },
            'Cloudy': { effect: 1.0, emoji: '‚òÅÔ∏è', message: 'Average day. Business as usual.' },
            'Rainy': { effect: 0.8, emoji: 'üåßÔ∏è', message: 'Gloomy day. Fewer people out, but they want comfort food.' },
            'Heatwave': { effect: 0.6, emoji: 'üî•', message: 'It\'s melting! Price must be low or they won\'t risk it.' },
            'Snowing': { effect: 1.5, emoji: '‚ùÑÔ∏è', message: 'Cold weather brings high demand for hot chocolate (and bars!).' }
        };

        const CUSTOMER_PROMPT_STANDARD = "A customer approaches. What price will you set for a single chocolate bar?";
        const CUSTOMER_PROMPT_RICH = "A delighted customer approaches, smelling the rich cocoa. What premium price will you set?";
        
        // --- Tone.js Sound Initialization ---
        const successSynth = new Tone.Synth({
            oscillator: { type: "square" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.2 },
        }).toDestination();
        
        const rejectSynth = new Tone.MetalSynth({
            frequency: 100,
            envelope: { attack: 0.001, decay: 0.2, release: 0.1 },
            harmonicity: 3.1,
            modulationIndex: 10,
            resonance: 800,
            octaves: 1.5
        }).toDestination();
        
        function playSuccessSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            successSynth.triggerAttackRelease("C5", "8n");
            setTimeout(() => successSynth.triggerAttackRelease("E5", "8n"), 100);
            setTimeout(() => successSynth.triggerAttackRelease("G5", "8n"), 200);
        }

        function playRejectSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            rejectSynth.triggerAttackRelease("G3", "16n", Tone.now(), 0.5);
            setTimeout(() => rejectSynth.triggerAttackRelease("C#3", "16n", Tone.now(), 0.5), 100);
        }

        // --- Utility functions for TTS (Kept for compatibility) ---
        window.base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        window.pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const dataView = new DataView(buffer);
            writeString(dataView, 0, 'RIFF');
            dataView.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(dataView, 8, 'WAVE');
            writeString(dataView, 12, 'fmt ');
            dataView.setUint32(16, 16, true);
            dataView.setUint16(20, 1, true); 
            dataView.setUint16(22, numChannels, true);
            dataView.setUint32(24, sampleRate, true);
            dataView.setUint32(28, sampleRate * numChannels * bytesPerSample, true); 
            dataView.setUint16(32, numChannels * bytesPerSample, true); 
            dataView.setUint16(34, 16, true); 
            writeString(dataView, 36, 'data');
            dataView.setUint32(40, pcmData.byteLength, true);
            const pcmView = new Int16Array(pcmData);
            for (let i = 0; i < pcmView.length; i++) {
                dataView.setInt16(44 + i * 2, pcmView[i], true);
            }
            return new Blob([dataView], { type: 'audio/wav' });
        };

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        async function speakText(text) {
            const ttsButton = document.getElementById('prompt-tts');
            if (ttsButton) {
                ttsButton.disabled = true;
                ttsButton.classList.add('opacity-50');
            }
            // ... (TTS implementation omitted for brevity, assumed to be working)
            // Error handling fallback for the TTS button:
            setTimeout(() => {
                if (ttsButton) {
                    ttsButton.disabled = false;
                    ttsButton.classList.remove('opacity-50');
                }
            }, 1000); 
        }
        window.speakText = speakText; 

        // --- Styling Functions (Crucial for customization) ---

        /**
         * Converts a Tailwind color/shade string (e.g., 'pink-600') to its hex value.
         * Used for setting CSS variables which control the aesthetic of the main card.
         */
        function getHexColor(colorClass) {
            const hexMap = {
                'pink-600': '#db2777', 'pink-700': '#be185d', 'pink-400': '#f472b6', 'pink-800': '#9d174d',
                'teal-600': '#0d9488', 'teal-700': '#0f766e', 'teal-400': '#2dd4bf', 'teal-800': '#0e7490',
                'amber-600': '#f59e0b', 'amber-700': '#d97706', 'amber-400': '#fbbf24', 'amber-800': '#b45309',
                'indigo-600': '#4f46e5', 'indigo-700': '#4338ca', 'indigo-400': '#818cf8', 'indigo-800': '#3730a3',
                'green-600': '#16a34a', 'green-400': '#4ade80',
                'red-600': '#dc2626', 'red-400': '#f87171',
                'yellow-600': '#ca8a04', 'yellow-400': '#facc15',
                'purple-600': '#9333ea', 'purple-700': '#7e22ce', 'purple-800': '#6b21a8'
            };
            return hexMap[colorClass] || '#db2777'; // Fallback to pink-600
        }


        function applyStyle() {
            const root = document.documentElement;
            const body = document.body;
            const color = COLOR_MAP[settingsState.accentColor];
            const rounding = ROUNDING_MAP[settingsState.borderRadius];

            // 1. Apply Dark Mode Class
            if (settingsState.isDarkMode) {
                root.classList.add('dark');
                body.classList.add('dark');
                document.getElementById('dark-mode-toggle').checked = true;
            } else {
                root.classList.remove('dark');
                body.classList.remove('dark');
                document.getElementById('dark-mode-toggle').checked = false;
            }

            // 2. Apply Accent Color CSS Variables
            root.style.setProperty('--primary-color', getHexColor(color.primary));
            root.style.setProperty('--primary-color-dark', getHexColor(color.primaryDark));
            root.style.setProperty('--secondary-color', getHexColor(color.secondary));
            root.style.setProperty('--secondary-color-dark', getHexColor(color.secondaryDark));

            // 3. Apply Rounding CSS Variable
            root.style.setProperty('--border-radius-size', rounding.cssVar);

            // 4. Apply Layout Mode Class
            if (settingsState.layoutMode === 'compact') {
                body.classList.add('compact');
            } else {
                body.classList.remove('compact');
            }

            // 5. Update Dynamic Elements
            updateDynamicElements(); 
        }
        window.applyStyle = applyStyle;

        // Function to update elements that need specific color classes applied directly
        function updateDynamicElements() {
            const color = COLOR_MAP[settingsState.accentColor];
            const colorBase = color.base;

            // Helper to generate text color classes (for headers and icons)
            const getTextColorClasses = (shade) => `text-${colorBase}-${shade} dark:text-${colorBase}-300`;

            // List of all possible text color classes to remove (to handle color switching correctly)
            const allColorTextClasses = [
                'text-pink-600', 'dark:text-pink-300', 'text-teal-600', 'dark:text-teal-300', 'text-amber-600', 'dark:text-amber-300', 'text-indigo-600', 'dark:text-indigo-300',
                'text-pink-700', 'dark:text-pink-300', 'text-teal-700', 'dark:text-teal-300', 'text-amber-700', 'dark:text-amber-300', 'text-indigo-700', 'dark:text-indigo-300'
            ];
            
            // 1. Re-apply primary title color (FIXING THE "BANNER" ISSUE)
            const title = document.querySelector('h1');
            // Remove previous dynamic color classes
            title.classList.remove(...allColorTextClasses);
            // We only want the font size/weight and the text color classes
            title.className = `text-3xl sm:text-4xl font-extrabold ${getTextColorClasses(700)}`; 

            // 2. Update main action button (needs background/shadow)
            const setPriceBtn = document.getElementById('set-price-button');
            setPriceBtn.className = `flex items-center justify-center bg-${colorBase}-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-${colorBase}-700 transition duration-150 shadow-lg shadow-${colorBase}-300 active:shadow-none active:translate-y-0.5 disabled:opacity-50 dark:bg-${colorBase}-700 dark:hover:bg-${colorBase}-800 dark:shadow-${colorBase}-500/50 w-full sm:w-auto`;

            // 3. Update TTS button color (icon)
            const ttsBtn = document.getElementById('prompt-tts');
            // Remove all previous dynamic color classes
            ttsBtn.classList.remove(...allColorTextClasses);
            // Add new dynamic color classes
            ttsBtn.classList.add(`text-${colorBase}-600`, `dark:text-${colorBase}-300`);

            // 4. Update Game Log title color
            const logTitle = document.querySelector('.chocolate-card h2');
            logTitle.classList.remove(...allColorTextClasses);
            logTitle.classList.add(`text-${colorBase}-700`, `dark:text-${colorBase}-300`);
            
            // 5. Update Modal Titles
            document.getElementById('settings-modal').querySelector('h3').classList.remove(...allColorTextClasses);
            document.getElementById('settings-modal').querySelector('h3').classList.add(...getTextColorClasses(700).split(' '));
            
            document.getElementById('upgrades-modal').querySelector('h3').classList.remove(...allColorTextClasses);
            document.getElementById('upgrades-modal').querySelector('h3').classList.add(...getTextColorClasses(700).split(' '));

            // 6. Update input focus ring color (needs to be done dynamically if we want it to match)
            const priceInput = document.getElementById('price-input');
            priceInput.classList.remove('border-pink-300', 'focus:ring-pink-500', 'focus:border-pink-500', 
                                     'border-teal-300', 'focus:ring-teal-500', 'focus:border-teal-500', 
                                     'border-amber-300', 'focus:ring-amber-500', 'focus:border-amber-500', 
                                     'border-indigo-300', 'focus:ring-indigo-500', 'focus:border-indigo-500');
            priceInput.classList.add(`border-${colorBase}-300`, `focus:ring-${colorBase}-500`, `focus:border-${colorBase}-500`);

        }
        window.updateDynamicElements = updateDynamicElements;


        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                if (storedSettings) {
                    const loaded = JSON.parse(storedSettings);
                    settingsState = { ...settingsState, ...loaded };
                }
            } catch (e) {
                console.error("Error loading settings from localStorage:", e);
            }
            applyStyle();
        }
        window.loadSettings = loadSettings;

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsState));
            } catch (e) {
                console.error("Error saving settings to localStorage:", e);
            }
        }

        function toggleDarkMode(value) {
            settingsState.isDarkMode = value;
            applyStyle();
            saveSettings();
        }
        window.toggleDarkMode = toggleDarkMode; 
        
        function changeAccentColor(color) {
            settingsState.accentColor = color;
            applyStyle();
            saveSettings();
        }
        window.changeAccentColor = changeAccentColor;

        function changeRounding(level) {
            settingsState.borderRadius = level;
            applyStyle();
            saveSettings();
        }
        window.changeRounding = changeRounding;

        function changeLayoutMode(mode) {
            settingsState.layoutMode = mode;
            applyStyle();
            saveSettings();
        }
        window.changeLayoutMode = changeLayoutMode;


        function updateUI() {
            document.getElementById('day-display').textContent = gameState.day;
            document.getElementById('money-display').textContent = gameState.money.toFixed(2);
            document.getElementById('orders-remaining').textContent = gameState.ordersRemaining;
            document.getElementById('total-orders').textContent = gameState.totalOrders;
            document.getElementById('weather-display').innerHTML = `${WEATHER_EFFECTS[gameState.weather].emoji} ${gameState.weather}`;
            document.getElementById('weather-info').textContent = WEATHER_EFFECTS[gameState.weather].message;

            const interactionArea = document.getElementById('interaction-area');
            const endDayBtn = document.getElementById('end-day-button');
            const richToggle = document.getElementById('rich-chocolate-toggle');

            richToggle.checked = gameState.richChocolate.isActive;

            if (gameState.ordersRemaining > 0) {
                endDayBtn.classList.add('hidden');
                interactionArea.classList.remove('hidden');
                
                if (!gameState.isProcessing) {
                    document.getElementById('acceptance-feedback').innerHTML = '';
                }

                document.getElementById('prompt-text').textContent = gameState.richChocolate.isActive ? CUSTOMER_PROMPT_RICH : CUSTOMER_PROMPT_STANDARD;

                const currentCost = gameState.richChocolate.isActive ? (BASE_COST_PER_BAR + RICH_CHOCOLATE_BONUS_COST).toFixed(2) : BASE_COST_PER_BAR.toFixed(2);
                document.getElementById('price-info').textContent = `Cost per bar: $${currentCost}`;
                
            } else {
                interactionArea.classList.add('hidden');
                endDayBtn.classList.remove('hidden');
            }
        }

        function logMessage(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const logEntry = document.createElement('div');
            let colorClass = 'text-gray-700 dark:text-gray-300';

            if (type === 'success') {
                colorClass = 'text-green-600 dark:text-green-400';
            } else if (type === 'error') {
                colorClass = 'text-red-600 dark:text-red-400';
            }

            logEntry.className = `p-2 ${colorClass} border-b border-gray-100 dark:border-gray-700`;
            logEntry.textContent = message;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight; 
        }

        // === Upgrades Logic ===

        function renderUpgradesModal() {
            const container = document.getElementById('upgrades-list');
            container.innerHTML = '';
            const upgrades = [UPGRADE_CONFIG.BANNER_1, UPGRADE_CONFIG.BANNER_2, UPGRADE_CONFIG.TIKTOK_PAGE];
            const color = COLOR_MAP[settingsState.accentColor];

            upgrades.forEach(config => {
                let isPurchased = false;
                let isDisabled = false;

                if (config.key.startsWith('BANNER')) {
                    const level = config.key.endsWith('1') ? 1 : 2;
                    isPurchased = gameState.upgrades.bannerLevel >= level;
                    if (level === 2 && gameState.upgrades.bannerLevel < 1) {
                        isDisabled = true;
                    } 
                } else if (config.key === 'TIKTOK_PAGE') {
                    isPurchased = gameState.upgrades.tiktokPage;
                }
                
                let statusText;
                if (isPurchased) {
                    statusText = `<span class="text-green-500 font-bold">OWNED</span>`;
                } else if (gameState.money < config.cost || isDisabled) {
                    statusText = `<span class="text-red-500 font-bold">Cost: $${config.cost.toFixed(2)}</span>`;
                    isDisabled = true;
                } else {
                    statusText = `<span class="text-${color.base}-500 font-bold">Cost: $${config.cost.toFixed(2)}</span>`;
                }

                const buttonClass = isPurchased ? 'bg-gray-400 cursor-not-allowed' : (isDisabled ? 'bg-gray-400 cursor-not-allowed' : `bg-${color.base}-600 hover:bg-${color.base}-700`);
                const buttonText = isPurchased ? 'Owned' : (isDisabled ? (config.key === 'BANNER_2' ? 'Requires Small Ad' : 'Locked') : 'Buy');

                container.innerHTML += `
                    <div class="p-4 chocolate-card flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0">
                        <div>
                            <p class="text-lg font-semibold dark:text-gray-200">${config.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${config.description}</p>
                            <p class="text-sm mt-1">${statusText}</p>
                        </div>
                        <button 
                            onclick="buyUpgrade('${config.key}')" 
                            class="w-full md:w-auto px-4 py-2 text-white font-bold transition duration-150 rounded-lg ${buttonClass}" 
                            ${isDisabled || isPurchased ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            document.getElementById('upgrades-modal').classList.remove('hidden');
        }
        window.renderUpgradesModal = renderUpgradesModal;


        function buyUpgrade(upgradeKey) {
            const config = UPGRADE_CONFIG[upgradeKey];
            if (!config) { logMessage("Error: Invalid upgrade key.", 'error'); return; }

            if (gameState.money < config.cost) {
                logMessage(`Cannot afford ${config.name}. Need $${config.cost.toFixed(2)}.`, 'error');
                return;
            }

            if (upgradeKey.startsWith('BANNER')) {
                const level = upgradeKey.endsWith('1') ? 1 : 2;
                if (gameState.upgrades.bannerLevel === level) { logMessage(`${config.name} already purchased!`, 'info'); return; }
                if (level === 2 && gameState.upgrades.bannerLevel < 1) { logMessage("Must purchase Small Banner Ad first.", 'error'); return; }

                gameState.money -= config.cost;
                gameState.upgrades.bannerLevel = level;
                logMessage(`Purchased ${config.name}! Max daily orders increased by ${config.orderIncrease}.`, 'success');

            } else if (upgradeKey === 'TIKTOK_PAGE') {
                if (gameState.upgrades.tiktokPage) { logMessage("TikTok Page already launched!", 'info'); return; }
                gameState.money -= config.cost;
                gameState.upgrades.tiktokPage = true;
                logMessage(`Launched TikTok Page! Max daily orders increased by ${config.orderIncrease} and customer hype is massive!`, 'success');
            }

            updateUI();
            saveGame();
            renderUpgradesModal();
        }
        window.buyUpgrade = buyUpgrade;


        // === Game Logic ===

        function toggleRichChocolate() {
            gameState.richChocolate.isActive = !gameState.richChocolate.isActive;
            logMessage(`Rich Chocolate mode is now ${gameState.richChocolate.isActive ? 'ACTIVE' : 'INACTIVE'}. Next customer will reflect this choice.`, 'info');
            updateUI();
            saveGame();
        }
        window.toggleRichChocolate = toggleRichChocolate;


        function startNewDayLogic() {
            gameState.day += 1;
            gameState.acceptedOrders = 0;
            gameState.rejectedOrders = 0;

            if (gameState.day > 1) {
                logMessage(`--- END OF DAY ${gameState.day - 1} SUMMARY ---`, 'info');
            }

            const weatherKeys = Object.keys(WEATHER_EFFECTS);
            gameState.weather = weatherKeys[Math.floor(Math.random() * weatherKeys.length)];

            let maxBaseOrders = BASE_MAX_ORDERS;
            if (gameState.upgrades.bannerLevel >= 1) { maxBaseOrders += UPGRADE_CONFIG.BANNER_1.orderIncrease; }
            if (gameState.upgrades.bannerLevel >= 2) { maxBaseOrders += UPGRADE_CONFIG.BANNER_2.orderIncrease; }
            if (gameState.upgrades.tiktokPage) { maxBaseOrders += UPGRADE_CONFIG.TIKTOK_PAGE.orderIncrease; }

            const fluctuation = Math.floor(Math.random() * (maxBaseOrders / 2));
            gameState.totalOrders = Math.max(5, maxBaseOrders + fluctuation); 
            gameState.ordersRemaining = gameState.totalOrders;

            logMessage(`--- DAY ${gameState.day} BEGINS ---`, 'info');
            logMessage(`Weather is ${gameState.weather}. Max expected customers: ${gameState.totalOrders}.`, 'info');

            updateUI();
        }

        async function startNewDay() {
            if (gameState.isProcessing) return;
            gameState.isProcessing = true;
            
            const overlay = document.getElementById('day-transition-overlay');
            const endDayBtn = document.getElementById('end-day-button');

            endDayBtn.disabled = true;
            overlay.classList.add('active'); 

            await new Promise(resolve => setTimeout(resolve, 100)); 

            logMessage("Saving game state to local storage...", 'info');
            await saveGame();
            logMessage("Save successful.", 'info');
            
            await new Promise(resolve => setTimeout(resolve, 4900)); 
            
            startNewDayLogic();

            overlay.classList.remove('active');
            endDayBtn.disabled = false;
            gameState.isProcessing = false;
        }
        window.startNewDay = startNewDay;


        // Core Decision Logic
        function checkAcceptance(price) {
            const isRich = gameState.richChocolate.isActive;
            let costOfGoods = BASE_COST_PER_BAR;
            let maxAcceptablePrice = BASE_MAX_ACCEPTABLE_PRICE;

            if (isRich) {
                costOfGoods += RICH_CHOCOLATE_BONUS_COST;
                maxAcceptablePrice += RICH_CHOCOLATE_MAX_PRICE_BONUS;
            }
            
            const priceRange = maxAcceptablePrice - costOfGoods;
            const normalizedPrice = Math.max(0, price - costOfGoods) / priceRange;
            
            const baseChance = Math.max(0, 1 - Math.pow(normalizedPrice, 2.5));

            const weatherEffect = WEATHER_EFFECTS[gameState.weather].effect;
            let finalChance = baseChance * weatherEffect;
            
            finalChance = Math.min(1.0, finalChance);
            
            const roll = Math.random();

            return {
                accepts: roll < finalChance,
                chance: finalChance,
                cost: costOfGoods
            };
        }

        function handlePriceSetting() {
            if (gameState.isProcessing) return;

            const priceInput = document.getElementById('price-input');
            const feedbackDiv = document.getElementById('acceptance-feedback');
            const price = parseFloat(priceInput.value);

            if (isNaN(price) || price <= 0) {
                logMessage("Please enter a valid price greater than $0.", 'error');
                return;
            }

            gameState.isProcessing = true;
            // Disable interaction elements
            document.getElementById('set-price-button').disabled = true;
            priceInput.disabled = true;
            document.getElementById('rich-chocolate-toggle').disabled = true;
            document.getElementById('prompt-tts').disabled = true;

            const { accepts, chance, cost } = checkAcceptance(price);
            const weatherEmoji = WEATHER_EFFECTS[gameState.weather].emoji;
            const color = COLOR_MAP[settingsState.accentColor];

            let message;
            let feedbackHtml;

            if (accepts) {
                playSuccessSound(); 
                const profit = price - cost;
                gameState.money += profit;
                gameState.acceptedOrders += 1;
                message = `${weatherEmoji} Accepted! Sold for $${price.toFixed(2)} (${gameState.richChocolate.isActive ? 'Rich' : 'Standard'}). Profit: $${profit.toFixed(2)}. (Chance: ${(chance * 100).toFixed(1)}%)`;
                
                feedbackHtml = `
                    <p class="text-green-600 dark:text-green-400 font-bold text-lg">
                        ‚úÖ ACCEPTED!
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Chance: ${(chance * 100).toFixed(1)}% | Profit: $${profit.toFixed(2)}
                    </p>
                `;
                logMessage(message, 'success');
            } else {
                playRejectSound(); 
                gameState.rejectedOrders += 1;
                message = `${weatherEmoji} Rejected! Customer walked away. (Chance: ${(chance * 100).toFixed(1)}%)`;
                
                feedbackHtml = `
                    <p class="text-red-600 dark:text-red-400 font-bold text-lg">
                        ‚ùå REJECTED
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Chance: ${(chance * 100).toFixed(1)}%
                    </p>
                `;
                logMessage(message, 'error');
            }

            feedbackDiv.innerHTML = feedbackHtml; 

            gameState.ordersRemaining -= 1;
            priceInput.value = price.toFixed(2); 

            updateUI(); 
            saveGame();

            if (gameState.ordersRemaining <= 0) {
                gameState.isProcessing = false;
                document.getElementById('set-price-button').disabled = false;
                priceInput.disabled = false;
                document.getElementById('rich-chocolate-toggle').disabled = false;
                document.getElementById('prompt-tts').disabled = false;
                return;
            }

            feedbackDiv.innerHTML += `
                <p class="mt-1 text-sm text-${color.base}-500 dark:text-${color.base}-400 font-medium animate-pulse">
                    Waiting for next customer...
                </p>
            `;
            
            setTimeout(() => {
                document.getElementById('set-price-button').disabled = false;
                priceInput.disabled = false;
                document.getElementById('rich-chocolate-toggle').disabled = false;
                document.getElementById('prompt-tts').disabled = false;
                
                gameState.isProcessing = false;
                
                updateUI(); 
            }, CUSTOMER_COOLDOWN_MS);

        }
        window.handlePriceSetting = handlePriceSetting;


        // === Local Storage Functions ===

        async function saveGame() {
            const saveState = JSON.parse(JSON.stringify(gameState));
            delete saveState.isProcessing;

            try {
                localStorage.setItem(GAME_DATA_KEY, JSON.stringify(saveState));
                await new Promise(resolve => setTimeout(resolve, 500)); 
            } catch (error) {
                console.error("Error saving game state to localStorage:", error);
                logMessage("Error saving game state to local storage! Progress might be lost.", 'error');
            }
        }
        window.saveGame = saveGame;

        async function loadGame() {
            document.getElementById('status-message').textContent = 'Loading game...';

            try {
                const savedData = localStorage.getItem(GAME_DATA_KEY);

                if (savedData) {
                    const loadedData = JSON.parse(savedData);
                    gameState = { ...DEFAULT_GAME_STATE, ...loadedData };
                    
                    gameState.upgrades = gameState.upgrades || DEFAULT_GAME_STATE.upgrades;
                    gameState.richChocolate = gameState.richChocolate || DEFAULT_GAME_STATE.richChocolate;

                    logMessage(`Game loaded successfully from local storage! Welcome back to Day ${gameState.day}.`, 'info');
                } else {
                    logMessage("No saved game found. Starting a new game.", 'info');
                }

                document.getElementById('status-message').textContent = 'Ready!';

                if (gameState.day === 0) {
                    startNewDayLogic(); // Start day 1
                } else {
                    updateUI(); // Display the loaded day
                }

            } catch (error) {
                console.error("Error loading game state from localStorage:", error);
                document.getElementById('status-message').textContent = 'Error loading game. Check console.';
                startNewDayLogic(); // Start new game on error
            }
        }
        window.loadGame = loadGame;

        // Initialize on window load
        window.onload = () => {
            window.loadSettings(); 
            window.loadGame(); 

            // Initialize all input and select states in the modal based on loaded settings
            document.getElementById('accent-color-select').value = settingsState.accentColor;
            document.getElementById('border-rounding-select').value = settingsState.borderRadius;
            document.getElementById('layout-mode-select').value = settingsState.layoutMode;


            document.getElementById('set-price-button').addEventListener('click', handlePriceSetting);
            document.getElementById('end-day-button').addEventListener('click', startNewDay); 
            document.getElementById('rich-chocolate-toggle').addEventListener('change', toggleRichChocolate);

            document.getElementById('prompt-tts').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                const prompt = gameState.richChocolate.isActive ? CUSTOMER_PROMPT_RICH : CUSTOMER_PROMPT_STANDARD;
                window.speakText(prompt); 
            });


            // Modal listeners
            document.getElementById('settings-button').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('hidden'));
            document.getElementById('close-settings-button').addEventListener('click', () => document.getElementById('settings-modal').classList.add('hidden'));
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => toggleDarkMode(e.target.checked));
            document.getElementById('accent-color-select').addEventListener('change', (e) => changeAccentColor(e.target.value));
            document.getElementById('border-rounding-select').addEventListener('change', (e) => changeRounding(e.target.value));
            document.getElementById('layout-mode-select').addEventListener('change', (e) => changeLayoutMode(e.target.value));
            
            document.getElementById('upgrades-button').addEventListener('click', renderUpgradesModal);
            document.getElementById('close-upgrades-modal').addEventListener('click', () => document.getElementById('upgrades-modal').classList.add('hidden'));

            document.getElementById('user-id-display-container').classList.add('hidden');
        };
    </script>
</head>
<body class="p-4 sm:p-8 container mx-auto">

    <div class="max-w-4xl mx-auto relative">
        <div class="flex justify-between items-center mb-6">
            <!-- Dynamic Title Color -->
            <h1 class="text-3xl sm:text-4xl font-extrabold text-pink-700 dark:text-pink-300">üç´ Chocolate Stand Tycoon üí∞</h1>
            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <!-- Upgrades Button -->
                <button id="upgrades-button" class="text-gray-500 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition" aria-label="Open Upgrades">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 14V8m-4 4h8"/></svg>
                </button>
                <!-- Settings Button -->
                <button id="settings-button" class="text-gray-500 dark:text-gray-300 hover:text-pink-600 dark:hover:text-pink-400 transition" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <p id="status-message" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4">Ready!</p>

        <!-- Stats Panel -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="p-4 chocolate-card text-center bg-pink-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Day</p>
                <p id="day-display" class="text-3xl font-bold text-pink-600 dark:text-pink-300">0</p>
            </div>
            <div class="p-4 chocolate-card text-center bg-green-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Money</p>
                <p class="text-3xl font-bold text-green-600 dark:text-green-400">$<span id="money-display">100.00</span></p>
            </div>
            <div class="p-4 chocolate-card text-center bg-yellow-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Orders Today</p>
                <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">
                    <span id="orders-remaining">0</span>/<span id="total-orders">0</span>
                </p>
            </div>
            <div class="p-4 chocolate-card text-center col-span-2 md:col-span-1 bg-blue-50 dark:bg-gray-700 dark:border-gray-500">
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Weather</p>
                <p id="weather-display" class="text-3xl font-bold text-blue-600 dark:text-blue-400">‚òÄÔ∏è Sunny</p>
            </div>
            <div class="p-4 chocolate-card text-left bg-gray-50 dark:bg-gray-700 dark:border-gray-500 col-span-2 md:col-span-4">
                <p id="weather-info" class="text-sm text-gray-600 dark:text-gray-300">Weather message will appear here.</p>
            </div>
        </div>

        <!-- Main Interaction Area -->
        <div id="interaction-area" class="chocolate-card p-6 mb-8 hidden">
            <!-- Chocolate Type Toggle -->
            <div class="flex justify-between items-center py-2 mb-4 bg-gray-50 dark:bg-gray-600 p-3 rounded-lg">
                <div class="flex items-center space-x-2">
                    <span class="text-xl" role="img" aria-label="Chocolate bar">üç´</span>
                    <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">Use Rich Chocolate?</span>
                    <p id="price-info" class="text-xs text-gray-500 dark:text-gray-400 ml-3">Cost per bar: $1.50</p>
                </div>
                <label for="rich-chocolate-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                    <input type="checkbox" id="rich-chocolate-toggle" class="rich-chocolate-toggle absolute w-full h-full opacity-0">
                    <span class="toggle-label absolute inset-0 bg-gray-300 rounded-full transition duration-300 ease-in-out">
                        <span class="toggle-checkbox absolute w-4 h-4 bg-white rounded-full transition duration-300 ease-in-out transform translate-x-1 translate-y-1 shadow-md border-2 border-gray-300"></span>
                    </span>
                </label>
            </div>


            <div class="flex items-start mb-4">
                <p id="prompt-text" class="text-xl font-semibold text-gray-800 dark:text-gray-200">A customer approaches. What price will you set for a single chocolate bar?</p>
                <!-- Dynamic TTS Button Color -->
                <button id="prompt-tts" class="ml-2 focus:outline-none text-pink-600 dark:text-pink-300 hover:scale-110 transition" aria-label="Read prompt aloud">
                    <span class="text-2xl" role="img" aria-label="Speaker icon">üîä</span>
                </button>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <!-- Price Input -->
                <input
                    type="number"
                    id="price-input"
                    placeholder="Price (e.g., 2.50)"
                    class="flex-grow p-3 border-2 border-pink-300 focus:ring-pink-500 focus:border-pink-500 transition duration-150 dark:bg-gray-600 dark:text-white dark:border-gray-500 disabled:opacity-75"
                    style="border-radius: var(--border-radius-size);"
                    step="0.01"
                    min="0.01"
                    value="2.50"
                >
                
                <!-- Acceptance Feedback Display -->
                <div id="acceptance-feedback" class="flex flex-col items-center justify-center min-w-[150px] h-full text-center p-2 bg-gray-100 dark:bg-gray-700 flex-shrink-0 order-first sm:order-none w-full sm:w-auto" style="border-radius: var(--border-radius-size);">
                    <!-- Feedback appears here -->
                </div>

                <!-- Dynamic Set Price Button Color -->
                <button
                    id="set-price-button"
                    class="flex items-center justify-center bg-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-700 transition duration-150 shadow-lg shadow-pink-300 active:shadow-none active:translate-y-0.5 disabled:opacity-50 dark:bg-pink-700 dark:hover:bg-pink-800 dark:shadow-pink-500/50 w-full sm:w-auto"
                >
                    Set Price
                </button>
            </div>
        </div>

        <!-- End Day Button (Hidden initially) -->
        <div class="text-center">
            <!-- End Day button uses a different purple color, keep it distinct -->
            <button
                id="end-day-button"
                class="flex items-center justify-center mx-auto bg-purple-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-purple-700 transition duration-150 shadow-xl shadow-purple-300 active:shadow-none active:translate-y-0.5 hidden dark:bg-purple-700 dark:hover:bg-purple-800 dark:shadow-purple-500/50"
                style="border-radius: var(--border-radius-size);"
            >
                Go to Bed
            </button>
        </div>


        <!-- Game Log -->
        <div class="chocolate-card p-4 mt-8">
            <!-- Dynamic Title Color -->
            <h2 class="text-2xl font-semibold text-pink-700 dark:text-pink-300 border-b pb-2 mb-2 dark:border-gray-600">Game Log</h2>
            <div id="log-area" class="h-48 overflow-y-auto text-sm dark:text-gray-300" style="max-height: 200px;">
                <!-- Log entries will be added here -->
            </div>
        </div>

        <!-- User ID Display (Hidden since Firestore is removed) -->
        <div id="user-id-display-container" class="mt-4 text-center text-xs text-gray-400 dark:text-gray-500">
            Game state saved locally in your browser storage.
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="chocolate-card w-full max-w-md p-6 dark:bg-gray-800 dark:text-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-pink-700 dark:text-pink-300">Settings</h3>
                <button id="close-settings-button" class="text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="space-y-4">
                <!-- 1. Dark Mode Toggle -->
                <div class="flex justify-between items-center py-3 border-b dark:border-gray-700">
                    <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                    <label for="dark-mode-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="absolute w-full h-full opacity-0">
                        <span class="toggle-label absolute inset-0 bg-gray-300 rounded-full transition duration-300 ease-in-out"></span>
                        <span class="toggle-checkbox absolute w-4 h-4 bg-white rounded-full transition duration-300 ease-in-out transform translate-x-1 translate-y-1 shadow-md border-2 border-gray-300"></span>
                    </label>
                </div>

                <!-- 2. Accent Color Select -->
                <div class="py-3 border-b dark:border-gray-700">
                    <label for="accent-color-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Accent Color</label>
                    <select id="accent-color-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <option value="pink">Pink (Sweet Berry)</option>
                        <option value="teal">Teal (Mint Chocolate)</option>
                        <option value="amber">Amber (Golden Wrapper)</option>
                        <option value="indigo">Indigo (Royal Delight)</option>
                    </select>
                </div>

                <!-- 3. Border Rounding Select -->
                <div class="py-3 border-b dark:border-gray-700">
                    <label for="border-rounding-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Border Rounding</label>
                    <select id="border-rounding-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <option value="sharp">Sharp (Modern/Boxy)</option>
                        <option value="default">Default (Rounded Edges)</option>
                        <option value="pill">Pill (Very Soft/Pill)</option>
                    </select>
                </div>

                <!-- 4. Layout Mode Select -->
                <div class="py-3">
                    <label for="layout-mode-select" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Layout Density</label>
                    <select id="layout-mode-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                        <option value="default">Default (Spacious)</option>
                        <option value="compact">Compact (Less Padding)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrades Modal -->
    <div id="upgrades-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="chocolate-card w-full max-w-2xl p-6 dark:bg-gray-800 dark:text-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-pink-700 dark:text-pink-300">Business Upgrades</h3>
                <button id="close-upgrades-modal" class="text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Invest in these upgrades to permanently increase your customer flow and total daily orders.</p>

            <div id="upgrades-list" class="space-y-4">
                <!-- Upgrades will be rendered here dynamically -->
            </div>
        </div>
    </div>

    <!-- Day Transition Overlay (Full Screen Dark/Saving Animation) -->
    <div id="day-transition-overlay" class="fixed inset-0 z-[100] transition-opacity duration-[5000ms] ease-in-out pointer-events-none flex items-center justify-center">
        <!-- Content in the center -->
        <div class="text-white flex flex-col items-center">
            <div class="saving-spinner border-4 border-t-4 border-gray-200 rounded-full w-12 h-12 mb-4"></div>
            <p class="text-lg font-semibold">Tucking in for the night...</p>
            <p class="text-sm">Saving progress to local storage...</p>
        </div>
    </div>

</body>
</html>
