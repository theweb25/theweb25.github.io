<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STORIEDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            -webkit-tap-highlight-color: transparent;
        }
        .story-card {
            background: #111;
            border: 1px solid #222;
            transition: transform 0.1s ease;
        }
        .story-card:active {
            transform: scale(0.98);
        }
        .glass-nav {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #222;
        }
        .video-container {
            width: 100%;
            height: calc(100vh - 80px);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Header / Navigation -->
    <nav class="glass-nav sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
        <h1 id="app-title" class="text-xl font-800 tracking-tighter text-red-500 cursor-pointer select-none">STORIEDB</h1>
        <button id="random-btn" class="bg-white text-black px-4 py-1.5 rounded-full text-sm font-semibold hover:bg-gray-200">
            Random
        </button>
    </nav>

    <!-- Search Bar -->
    <div class="px-4 pt-4">
        <div class="relative">
            <input type="text" id="search-input" placeholder="Search stories..." 
                class="w-full bg-[#111] border border-[#222] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
    </div>

    <!-- Database Stats -->
    <div id="stats-container" class="px-4 py-3 flex gap-2 overflow-x-auto whitespace-nowrap">
        <div class="bg-[#111] border border-[#222] px-3 py-1.5 rounded-lg flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-600"></span>
            <span class="text-xs font-semibold text-gray-400">Videos: <span id="count-video" class="text-white">0</span></span>
        </div>
        <div class="bg-[#111] border border-[#222] px-3 py-1.5 rounded-lg flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-600"></span>
            <span class="text-xs font-semibold text-gray-400">External: <span id="count-external" class="text-white">0</span></span>
        </div>
        <div class="bg-[#111] border border-[#222] px-3 py-1.5 rounded-lg flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-600"></span>
            <span class="text-xs font-semibold text-gray-400">Texts: <span id="count-text" class="text-white">0</span></span>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="story-container" class="px-4 space-y-4">
        <div class="animate-pulse space-y-4">
            <div class="h-32 bg-[#111] rounded-xl"></div>
            <div class="h-32 bg-[#111] rounded-xl"></div>
            <div class="h-32 bg-[#111] rounded-xl"></div>
        </div>
    </main>

    <!-- Fullscreen Story Modal -->
    <div id="story-modal" class="fixed inset-0 z-[60] bg-black hidden overflow-y-auto">
        <div class="flex flex-col min-h-screen">
            <div class="p-4 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-10">
                <button id="close-modal" class="text-white text-lg font-bold p-2 bg-white/10 rounded-lg">âœ• Close</button>
            </div>
            <div id="modal-content" class="flex-grow flex flex-col">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Hidden Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-6 hidden">
        <div class="bg-[#111] border border-[#222] w-full max-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Database Settings</h2>
            <p class="text-sm text-gray-400 mb-4">Enter your GitHub Raw URL:</p>
            <input type="text" id="db-url-input" placeholder="https://raw.githubusercontent.com/..." 
                class="w-full bg-black border border-[#333] rounded-lg px-4 py-2 mb-4 text-sm focus:border-red-500 outline-none">
            <div class="flex gap-3">
                <button id="save-settings" class="flex-1 bg-red-600 font-bold py-2 rounded-lg">Save</button>
                <button id="cancel-settings" class="flex-1 bg-[#222] font-bold py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_DB = 'https://son0ra.github.io/storiedb.txt';
        let DB_URL = localStorage.getItem('story_db_url') || DEFAULT_DB;
        
        let stories = [];
        const container = document.getElementById('story-container');
        const searchInput = document.getElementById('search-input');
        const randomBtn = document.getElementById('random-btn');
        const modal = document.getElementById('story-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModal = document.getElementById('close-modal');
        const appTitle = document.getElementById('app-title');
        const settingsModal = document.getElementById('settings-modal');
        const dbUrlInput = document.getElementById('db-url-input');
        const saveSettings = document.getElementById('save-settings');
        const cancelSettings = document.getElementById('cancel-settings');

        // Stats Elements
        const countVideo = document.getElementById('count-video');
        const countExternal = document.getElementById('count-external');
        const countText = document.getElementById('count-text');

        let clickCount = 0;
        let clickTimer;

        appTitle.onclick = () => {
            clickCount++;
            clearTimeout(clickTimer);
            if (clickCount >= 5) {
                clickCount = 0;
                dbUrlInput.value = DB_URL;
                settingsModal.classList.remove('hidden');
            }
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        };

        saveSettings.onclick = () => {
            DB_URL = dbUrlInput.value.trim() || DEFAULT_DB;
            localStorage.setItem('story_db_url', DB_URL);
            settingsModal.classList.add('hidden');
            fetchStories(); 
        };

        cancelSettings.onclick = () => {
            settingsModal.classList.add('hidden');
        };

        function parseDatabase(text) {
            if (!text || !text.trim()) return [];
            const sections = text.replace(/\r\n/g, '\n').split(/\n-\n/);
            return sections.map(section => {
                const lines = section.trim().split('\n');
                const story = {};
                lines.forEach(line => {
                    const l = line.trim();
                    if (l.toLowerCase().startsWith('title:')) story.title = l.substring(6).trim();
                    if (l.toLowerCase().startsWith('text:')) story.text = l.substring(5).trim();
                    if (l.toLowerCase().startsWith('video:')) {
                        story.video = l.substring(6).trim();
                        story.isExternal = false;
                    }
                    if (l.toLowerCase().startsWith('videoe:')) {
                        story.video = l.substring(7).trim();
                        story.isExternal = true;
                    }
                });
                return story;
            }).filter(s => s.title && s.title.toLowerCase() !== 'placeholder' && !s.title.startsWith('//'));
        }

        async function fetchStories() {
            try {
                let targetUrl = DB_URL;
                if (targetUrl.startsWith('http://')) {
                    targetUrl = targetUrl.replace('http://', 'https://');
                }

                const response = await fetch(targetUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'text/plain' }
                });

                if (!response.ok) throw new Error('Network error');
                const dataText = await response.text();
                
                stories = parseDatabase(dataText);
                updateStats(stories);
                renderStories(stories);
            } catch (err) {
                console.error("Fetch error:", err);
                renderStories([]); 
            }
        }

        function updateStats(items) {
            let v = 0, e = 0, t = 0;
            items.forEach(s => {
                if (s.video && s.video !== '(link goes here)') {
                    if (s.isExternal) e++; else v++;
                } else {
                    t++;
                }
            });
            countVideo.textContent = v;
            countExternal.textContent = e;
            countText.textContent = t;
        }

        function renderStories(items) {
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<div class="py-20 text-gray-500 text-center"><p>(no info)</p></div>`;
                return;
            }

            items.forEach((story) => {
                const card = document.createElement('div');
                card.className = 'story-card p-5 rounded-2xl cursor-pointer';
                card.onclick = () => openStory(story);
                
                let typeLabel = '';
                const hasVideo = story.video && story.video !== '(link goes here)';

                if (hasVideo) {
                    typeLabel = !story.isExternal ? 
                        `<span class="text-[10px] bg-red-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-white">Video</span>` :
                        `<span class="text-[10px] bg-yellow-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-black">External Link</span>`;
                } else {
                    typeLabel = `<span class="text-[10px] bg-blue-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-white">Text</span>`;
                }

                card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        ${typeLabel}
                        <h2 class="text-lg font-semibold leading-tight">${story.title}</h2>
                        <p class="text-gray-400 text-sm line-clamp-2">
                            ${story.text || (story.isExternal ? 'External story link available...' : 'Watch video for the full story...')}
                        </p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openStory(story) {
            const videoUrl = story.video ? story.video.trim() : '';
            const hasVideo = videoUrl && videoUrl !== '(link goes here)';

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            if (hasVideo && story.isExternal) {
                modalContent.innerHTML = `
                    <div class="flex-grow flex flex-col items-center justify-center text-center p-6">
                        <h1 class="text-2xl font-bold mb-4">${story.title}</h1>
                        <div class="bg-[#111] p-6 rounded-2xl border border-yellow-600/50 mb-6">
                            <p class="text-yellow-500 font-semibold mb-2 text-lg">Redirecting...</p>
                            <p class="text-gray-400">The story will not show on the page so instead you will be redirected.</p>
                        </div>
                        <p class="text-xs text-gray-600 mb-8 break-all max-w-xs">${videoUrl}</p>
                        <a href="${videoUrl}" target="_blank" class="bg-white text-black px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-200 transition-colors">Go to Story</a>
                    </div>
                `;
                setTimeout(() => { window.open(videoUrl, '_blank'); }, 2000);
                return;
            }

            let mediaHtml = '';
            if (hasVideo && !story.isExternal) {
                mediaHtml = `
                    <div class="video-container flex-grow">
                        <video controls autoplay playsinline loop class="shadow-2xl">
                            <source src="${videoUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            }

            const cleanText = (story.text || '').trim();
            modalContent.innerHTML = `
                ${mediaHtml}
                <div class="p-6 bg-gradient-to-t from-black via-black to-transparent">
                    <h1 class="text-2xl font-bold mb-4">${story.title}</h1>
                    ${cleanText ? `<div class="text-gray-300 text-lg leading-relaxed whitespace-pre-wrap pb-10">${cleanText}</div>` : ''}
                    ${(!cleanText && !hasVideo) ? '<p class="text-gray-500 italic">No content available.</p>' : ''}
                </div>
            `;
        }

        closeModal.onclick = () => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            modalContent.innerHTML = ''; 
        };

        searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = stories.filter(s => 
                s.title.toLowerCase().includes(term) || 
                (s.text && s.text.toLowerCase().includes(term))
            );
            renderStories(filtered);
        };

        randomBtn.onclick = () => {
            if (stories.length === 0) return;
            const randomStory = stories[Math.floor(Math.random() * stories.length)];
            openStory(randomStory);
        };

        window.onload = fetchStories;
    </script>
</body>
</html>
