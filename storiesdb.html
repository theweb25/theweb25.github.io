<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STORIEDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-red: #ef4444;
            --bg-black: #050505;
            --card-bg: rgba(15, 15, 15, 0.7);
            --card-hover: rgba(22, 22, 22, 0.85);
            --border: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-black);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(5, 5, 5, 0.4), rgba(5, 5, 5, 0.8));
            z-index: -1;
        }
        .glass {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .story-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        @media (hover: hover) {
            .story-card:hover {
                border-color: rgba(255, 255, 255, 0.3);
                transform: translateY(-4px);
                background: var(--card-hover);
            }
        }
        .story-card:active {
            transform: scale(0.98);
        }
        .mini-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.6);
        }
        .media-container {
            width: 100%;
            min-height: 300px;
            max-height: 70vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .media-container video, .media-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body class="selection:bg-red-500/30">

    <!-- Header -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 flex items-center justify-between">
        <div id="app-logo-container" class="cursor-pointer active:opacity-70 transition-opacity">
            <img id="main-logo" src="s.txt" alt="Logo" class="h-6 w-auto object-contain" onerror="this.style.display='none'; document.getElementById('logo-text').style.display='block'">
            <h1 id="logo-text" class="hidden text-lg font-900 tracking-tighter text-white">STORIEDB</h1>
        </div>
        
        <!-- Compact Stats -->
        <div class="flex gap-4">
            <div class="mini-stat"><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> <span id="count-video">0</span></div>
            <div class="mini-stat"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> <span id="count-image">0</span></div>
            <div class="mini-stat"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div> <span id="count-text">0</span></div>
        </div>
    </nav>

    <!-- Search Area -->
    <div class="max-w-7xl mx-auto px-6 mt-8 mb-8">
        <div class="relative group">
            <input type="text" id="search-input" placeholder="Find something..." 
                class="w-full bg-black/20 backdrop-blur-md border border-white/10 rounded-2xl px-6 py-4 text-white focus:outline-none focus:border-white/30 transition-all">
            <div class="absolute right-5 top-1/2 -translate-y-1/2 text-white/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <main id="story-container" class="max-w-7xl mx-auto px-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 pb-24">
        <div class="h-40 bg-white/5 border border-white/5 rounded-3xl animate-pulse"></div>
        <div class="h-40 bg-white/5 border border-white/5 rounded-3xl animate-pulse"></div>
        <div class="h-40 bg-white/5 border border-white/5 rounded-3xl animate-pulse"></div>
    </main>

    <!-- Modal -->
    <div id="story-modal" class="fixed inset-0 z-[60] bg-black hidden overflow-y-auto">
        <div class="max-w-4xl mx-auto min-h-screen flex flex-col p-4 sm:p-8 pb-20">
            <div class="flex justify-start mb-6 sticky top-0 bg-black/20 backdrop-blur-lg py-2 z-20">
                <button id="close-modal" class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center bg-white/5 text-white">âœ•</button>
            </div>
            <div id="modal-content" class="animate-fade-in flex-grow"></div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/95 flex items-center justify-center p-6 hidden">
        <div class="bg-[#0f0f0f] border border-[#222] w-full max-w-md rounded-3xl p-8 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">DB Settings</h2>
            <input type="text" id="db-url-input" class="w-full bg-black border border-[#333] rounded-xl px-4 py-3 text-sm focus:border-white outline-none mb-4">
            <div class="flex gap-3">
                <button id="save-settings" class="flex-1 bg-white text-black font-bold py-3 rounded-xl">Save</button>
                <button id="cancel-settings" class="flex-1 bg-[#222] font-bold py-3 rounded-xl">Back</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_DB = 'https://son0ra.github.io/storiedb.txt'; 
        const WALLPAPER_API = 'https://raw.githubusercontent.com/npanuhin/Bing-Wallpaper-Archive/refs/heads/master/api/US/en.json';
        
        let DB_URL = localStorage.getItem('story_db_url') || DEFAULT_DB;
        let stories = [];

        const container = document.getElementById('story-container');
        const searchInput = document.getElementById('search-input');
        const modal = document.getElementById('story-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModal = document.getElementById('close-modal');
        const appLogo = document.getElementById('app-logo-container');
        const settingsModal = document.getElementById('settings-modal');
        const dbUrlInput = document.getElementById('db-url-input');
        const saveSettings = document.getElementById('save-settings');
        const cancelSettings = document.getElementById('cancel-settings');

        async function setDynamicBackground() {
            try {
                const response = await fetch(WALLPAPER_API);
                const data = await response.json();
                if (data && data.length > 0) {
                    // Pick a random image from the array
                    const randomIndex = Math.floor(Math.random() * data.length);
                    const randomImage = data[randomIndex].url;
                    document.body.style.backgroundImage = `url('${randomImage}')`;
                }
            } catch (err) {}
        }

        let clickCount = 0;
        let clickTimer;
        appLogo.onclick = () => {
            clickCount++;
            clearTimeout(clickTimer);
            if (clickCount >= 5) {
                clickCount = 0;
                dbUrlInput.value = DB_URL;
                settingsModal.classList.remove('hidden');
            }
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        };

        saveSettings.onclick = () => {
            DB_URL = dbUrlInput.value.trim() || DEFAULT_DB;
            localStorage.setItem('story_db_url', DB_URL);
            settingsModal.classList.add('hidden');
            fetchStories(); 
        };

        cancelSettings.onclick = () => settingsModal.classList.add('hidden');

        function parseDatabase(text) {
            if (!text || !text.trim()) return [];
            const sections = text.replace(/\r\n/g, '\n').split(/\n-\n/);
            return sections.map(section => {
                const lines = section.trim().split('\n');
                const story = {};
                lines.forEach(line => {
                    const l = line.trim();
                    const lowerL = l.toLowerCase();
                    if (lowerL.startsWith('title:')) story.title = l.substring(6).trim();
                    if (lowerL.startsWith('text:')) story.text = l.substring(5).trim();
                    if (lowerL.startsWith('video:')) { story.video = l.substring(6).trim(); story.isExternal = false; }
                    if (lowerL.startsWith('videoe:')) { story.video = l.substring(7).trim(); story.isExternal = true; }
                    if (lowerL.startsWith('image:')) story.image = l.substring(6).trim();
                });
                return story;
            }).filter(s => s.title && s.title.toLowerCase() !== 'placeholder' && !s.title.startsWith('//'));
        }

        async function fetchStories() {
            try {
                const response = await fetch(DB_URL);
                const dataText = await response.text();
                stories = parseDatabase(dataText);
                updateStats(stories);
                renderStories(stories);
            } catch (err) {
                container.innerHTML = `<div class="col-span-full py-20 text-center text-white/30">Offline</div>`;
            }
        }

        function updateStats(items) {
            let v = 0, e = 0, t = 0, i = 0;
            items.forEach(s => {
                if (s.video) { if (s.isExternal) e++; else v++; }
                else if (s.image) i++;
                else t++;
            });
            document.getElementById('count-video').textContent = v + e;
            document.getElementById('count-image').textContent = i;
            document.getElementById('count-text').textContent = t;
        }

        function renderStories(items) {
            container.innerHTML = '';
            items.forEach((story, idx) => {
                const card = document.createElement('div');
                card.className = 'story-card p-5 sm:p-6 rounded-[1.8rem] cursor-pointer group animate-fade-in';
                card.style.animationDelay = `${idx * 0.05}s`;
                card.onclick = () => openStory(story);
                
                let type = 'TEXT', textClass = 'text-blue-400';
                if (story.video) {
                    if (story.isExternal) { type = 'EXTERNAL'; textClass = 'text-yellow-400'; }
                    else { type = 'VIDEO'; textClass = 'text-red-400'; }
                } else if (story.image) { type = 'IMAGE'; textClass = 'text-green-400'; }

                card.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[9px] font-black tracking-widest ${textClass} opacity-80">${type}</span>
                        </div>
                        <h2 class="text-lg font-bold leading-tight mb-2">${story.title}</h2>
                        <p class="text-white/40 text-xs line-clamp-2 leading-relaxed">${story.text || 'View details...'}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openStory(story) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            if (story.video && story.isExternal) {
                modalContent.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-center"><h1 class="text-2xl font-bold mb-4">${story.title}</h1><a href="${story.video}" target="_blank" class="bg-white text-black px-8 py-3 rounded-full font-bold">Open Link</a></div>`;
                return;
            }

            let mediaHtml = '';
            if (story.video && !story.isExternal) {
                mediaHtml = `<div class="media-container mb-6"><video controls autoplay playsinline loop src="${story.video}"></video></div>`;
            } else if (story.image) {
                mediaHtml = `<div class="media-container mb-6"><img src="${story.image}"></div>`;
            }

            modalContent.innerHTML = `${mediaHtml}<h1 class="text-3xl font-bold mb-6">${story.title}</h1><div class="text-white/80 text-lg leading-relaxed whitespace-pre-wrap">${story.text || ''}</div>`;
        }

        searchInput.oninput = () => {
            const term = searchInput.value.toLowerCase();
            renderStories(stories.filter(s => s.title.toLowerCase().includes(term) || (s.text && s.text.toLowerCase().includes(term))));
        };

        closeModal.onclick = () => { modal.classList.add('hidden'); document.body.style.overflow = ''; };

        window.onload = () => {
            setDynamicBackground();
            fetchStories();
        };
    </script>
</body>
</html>
