<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Story Finisher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            -webkit-tap-highlight-color: transparent;
        }
        .story-card {
            background: #111;
            border: 1px solid #222;
            transition: transform 0.1s ease;
        }
        .story-card:active {
            transform: scale(0.98);
        }
        .glass-nav {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #222;
        }
        .video-container {
            aspect-ratio: 9/16;
            background: #000;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Header / Navigation -->
    <nav class="glass-nav sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
        <h1 id="app-title" class="text-xl font-800 tracking-tighter text-red-500 cursor-pointer select-none">STORYDB</h1>
        <button id="random-btn" class="bg-white text-black px-4 py-1.5 rounded-full text-sm font-semibold hover:bg-gray-200">
            Random
        </button>
    </nav>

    <!-- Search Bar -->
    <div class="px-4 py-4">
        <div class="relative">
            <input type="text" id="search-input" placeholder="Search stories..." 
                class="w-full bg-[#111] border border-[#222] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="story-container" class="px-4 space-y-4">
        <!-- Skeleton Loading -->
        <div class="animate-pulse space-y-4">
            <div class="h-32 bg-[#111] rounded-xl"></div>
            <div class="h-32 bg-[#111] rounded-xl"></div>
            <div class="h-32 bg-[#111] rounded-xl"></div>
        </div>
    </main>

    <!-- Fullscreen Story Modal -->
    <div id="story-modal" class="fixed inset-0 z-[60] bg-black hidden overflow-y-auto">
        <div class="flex flex-col min-h-screen">
            <div class="p-4 flex justify-between items-center sticky top-0 bg-black/50 backdrop-blur-md z-10">
                <button id="close-modal" class="text-white text-lg p-2">âœ• Close</button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Hidden Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-6 hidden">
        <div class="bg-[#111] border border-[#222] w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Database Settings</h2>
            <p class="text-sm text-gray-400 mb-4">Enter your GitHub Raw URL:</p>
            <input type="text" id="db-url-input" placeholder="https://raw.githubusercontent.com/..." 
                class="w-full bg-black border border-[#333] rounded-lg px-4 py-2 mb-4 text-sm focus:border-red-500 outline-none">
            <div class="flex gap-3">
                <button id="save-settings" class="flex-1 bg-red-600 font-bold py-2 rounded-lg">Save</button>
                <button id="cancel-settings" class="flex-1 bg-[#222] font-bold py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_DB = 'https://son0ra.github.io/storiedb.txt';
        let DB_URL = localStorage.getItem('story_db_url') || DEFAULT_DB;
        
        let stories = [];
        const container = document.getElementById('story-container');
        const searchInput = document.getElementById('search-input');
        const randomBtn = document.getElementById('random-btn');
        const modal = document.getElementById('story-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModal = document.getElementById('close-modal');
        const appTitle = document.getElementById('app-title');
        const settingsModal = document.getElementById('settings-modal');
        const dbUrlInput = document.getElementById('db-url-input');
        const saveSettings = document.getElementById('save-settings');
        const cancelSettings = document.getElementById('cancel-settings');

        let clickCount = 0;
        let clickTimer;

        appTitle.onclick = () => {
            clickCount++;
            clearTimeout(clickTimer);
            if (clickCount >= 5) {
                clickCount = 0;
                dbUrlInput.value = DB_URL;
                settingsModal.classList.remove('hidden');
            }
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        };

        saveSettings.onclick = () => {
            DB_URL = dbUrlInput.value.trim() || DEFAULT_DB;
            localStorage.setItem('story_db_url', DB_URL);
            settingsModal.classList.add('hidden');
            fetchStories(); 
        };

        cancelSettings.onclick = () => {
            settingsModal.classList.add('hidden');
        };

        function parseDatabase(text) {
            if (!text || !text.trim()) return [];
            const sections = text.replace(/\r\n/g, '\n').split(/\n-\n/);
            return sections.map(section => {
                const lines = section.trim().split('\n');
                const story = {};
                lines.forEach(line => {
                    const l = line.trim();
                    if (l.toLowerCase().startsWith('title:')) story.title = l.substring(6).trim();
                    if (l.toLowerCase().startsWith('text:')) story.text = l.substring(5).trim();
                    if (l.toLowerCase().startsWith('video:')) story.video = l.substring(6).trim();
                });
                return story;
            }).filter(s => s.title && s.title.toLowerCase() !== 'placeholder' && !s.title.startsWith('//'));
        }

        async function fetchStories() {
            try {
                let targetUrl = DB_URL;
                if (targetUrl.startsWith('http://')) {
                    targetUrl = targetUrl.replace('http://', 'https://');
                }

                const response = await fetch(targetUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'text/plain' }
                });

                if (!response.ok) throw new Error('Network error');
                const dataText = await response.text();
                
                stories = parseDatabase(dataText);
                renderStories(stories);
            } catch (err) {
                console.error("Fetch error:", err);
                renderStories([]); 
            }
        }

        function isDirectVideo(url) {
            if (!url) return false;
            const videoExtensions = ['.mp4', '.mov', '.webm', '.ogg', '.m4v'];
            const urlPath = url.split('?')[0].toLowerCase();
            return videoExtensions.some(ext => urlPath.endsWith(ext));
        }

        function renderStories(items) {
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-gray-500">
                        <p class="text-lg">(no info)</p>
                    </div>
                `;
                return;
            }

            items.forEach((story, index) => {
                const card = document.createElement('div');
                card.className = 'story-card p-5 rounded-2xl cursor-pointer';
                card.onclick = () => openStory(story);
                
                let typeLabel = '';
                if (story.video) {
                    const direct = isDirectVideo(story.video);
                    typeLabel = direct ? 
                        `<span class="text-[10px] bg-red-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest">Video</span>` :
                        `<span class="text-[10px] bg-yellow-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-black">External Link</span>`;
                } else {
                    typeLabel = `<span class="text-[10px] bg-blue-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest">Text</span>`;
                }

                card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        ${typeLabel}
                        <h2 class="text-lg font-semibold leading-tight">${story.title}</h2>
                        <p class="text-gray-400 text-sm line-clamp-2">
                            ${story.text || (isDirectVideo(story.video) ? 'Watch video for the full story...' : 'External story link available...')}
                        </p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openStory(story) {
            const videoUrl = story.video ? story.video.trim() : '';
            const isDirect = isDirectVideo(videoUrl);

            // If it's a video link but NOT direct, show redirect notice
            if (videoUrl && !isDirect && videoUrl !== '(link goes here)') {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                modalContent.innerHTML = `
                    <div class="flex flex-col items-center text-center py-10">
                        <h1 class="text-2xl font-bold mb-4">${story.title}</h1>
                        <div class="bg-[#111] p-6 rounded-2xl border border-yellow-600/50 mb-6">
                            <p class="text-yellow-500 font-semibold mb-2 text-lg">Redirecting...</p>
                            <p class="text-gray-400">The story will not show on the page so instead you will be redirected.</p>
                        </div>
                        <p class="text-sm text-gray-500 mb-8">URL: ${videoUrl}</p>
                        <a href="${videoUrl}" target="_blank" class="bg-white text-black px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-200 transition-colors">
                            Go to Story
                        </a>
                    </div>
                `;
                // Optional auto-redirect after delay
                setTimeout(() => {
                    window.open(videoUrl, '_blank');
                }, 2000);
                return;
            }

            // Normal flow for text or direct video
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            let mediaHtml = '';
            if (videoUrl && isDirect) {
                mediaHtml = `
                    <div class="video-container rounded-2xl overflow-hidden mb-6">
                        <video controls autoplay class="w-full h-full object-cover">
                            <source src="${videoUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            }

            const cleanText = (story.text || '').trim();

            modalContent.innerHTML = `
                <h1 class="text-3xl font-bold mb-4">${story.title}</h1>
                ${mediaHtml}
                <div class="text-gray-300 text-lg leading-relaxed whitespace-pre-wrap">${cleanText}</div>
            `;
        }

        closeModal.onclick = () => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            modalContent.innerHTML = ''; 
        };

        searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = stories.filter(s => 
                s.title.toLowerCase().includes(term) || 
                (s.text && s.text.toLowerCase().includes(term))
            );
            renderStories(filtered);
        };

        randomBtn.onclick = () => {
            if (stories.length === 0) return;
            const randomStory = stories[Math.floor(Math.random() * stories.length)];
            openStory(randomStory);
        };

        window.onload = fetchStories;
    </script>
</body>
</html>
