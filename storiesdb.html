<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STORIEDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            -webkit-tap-highlight-color: transparent;
        }
        .story-card {
            background: #111;
            border: 1px solid #222;
            transition: transform 0.1s ease;
        }
        .story-card:active {
            transform: scale(0.98);
        }
        .glass-nav {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #222;
        }
        .media-container {
            width: 100%;
            height: calc(100vh - 120px);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .media-container video, .media-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header / Navigation -->
    <nav class="glass-nav sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
        <div class="flex items-baseline gap-2">
            <h1 id="app-title" class="text-xl font-800 tracking-tighter text-red-500 cursor-pointer select-none">STORIEDB</h1>
            <span id="visit-count" class="text-[10px] font-mono text-gray-700 select-none">...</span>
        </div>
        <button id="random-btn" class="bg-white text-black px-4 py-1.5 rounded-full text-sm font-semibold hover:bg-gray-200">
            Random
        </button>
    </nav>

    <!-- Search Bar -->
    <div class="px-4 pt-4">
        <div class="relative">
            <input type="text" id="search-input" placeholder="Search stories..." 
                class="w-full bg-[#111] border border-[#222] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
    </div>

    <!-- Database Stats -->
    <div id="stats-container" class="px-4 py-4 flex gap-4 overflow-x-auto no-scrollbar whitespace-nowrap border-b border-[#111]">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-600"></span>
            <span class="text-[10px] font-bold text-gray-400 uppercase">Videos: <span id="count-video" class="text-white">0</span></span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-600"></span>
            <span class="text-[10px] font-bold text-gray-400 uppercase">Images: <span id="count-image" class="text-white">0</span></span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-600"></span>
            <span class="text-[10px] font-bold text-gray-400 uppercase">Ext: <span id="count-external" class="text-white">0</span></span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-600"></span>
            <span class="text-[10px] font-bold text-gray-400 uppercase">Texts: <span id="count-text" class="text-white">0</span></span>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="story-container" class="px-4 space-y-4 pt-4 pb-12">
        <div class="animate-pulse space-y-4">
            <div class="h-32 bg-[#111] rounded-xl"></div>
            <div class="h-32 bg-[#111] rounded-xl"></div>
        </div>
    </main>

    <!-- Fullscreen Story Modal -->
    <div id="story-modal" class="fixed inset-0 z-[60] bg-black hidden overflow-y-auto">
        <div class="flex flex-col min-h-screen">
            <div class="p-4 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-10">
                <button id="close-modal" class="text-white text-sm font-bold px-4 py-2 bg-white/10 rounded-lg">âœ• Close</button>
            </div>
            <div id="modal-content" class="flex-grow flex flex-col">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Hidden Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-6 hidden">
        <div class="bg-[#111] border border-[#222] w-full max-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-red-500">Database Settings</h2>
            <p class="text-sm text-gray-400 mb-4">Enter your GitHub Raw URL:</p>
            <input type="text" id="db-url-input" placeholder="https://raw.githubusercontent.com/..." 
                class="w-full bg-black border border-[#333] rounded-lg px-4 py-2 mb-4 text-sm focus:border-red-500 outline-none">
            <div class="flex gap-3">
                <button id="save-settings" class="flex-1 bg-red-600 font-bold py-2 rounded-lg">Save</button>
                <button id="cancel-settings" class="flex-1 bg-[#222] font-bold py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_DB = 'https://son0ra.github.io/storiedb.txt';
        let DB_URL = localStorage.getItem('story_db_url') || DEFAULT_DB;
        
        let stories = [];
        let currentRawVisitCount = "...";

        const container = document.getElementById('story-container');
        const searchInput = document.getElementById('search-input');
        const randomBtn = document.getElementById('random-btn');
        const modal = document.getElementById('story-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModal = document.getElementById('close-modal');
        const appTitle = document.getElementById('app-title');
        const settingsModal = document.getElementById('settings-modal');
        const dbUrlInput = document.getElementById('db-url-input');
        const saveSettings = document.getElementById('save-settings');
        const cancelSettings = document.getElementById('cancel-settings');

        const countVideo = document.getElementById('count-video');
        const countImage = document.getElementById('count-image');
        const countExternal = document.getElementById('count-external');
        const countText = document.getElementById('count-text');
        const visitCount = document.getElementById('visit-count');

        let clickCount = 0;
        let clickTimer;

        appTitle.onclick = () => {
            clickCount++;
            clearTimeout(clickTimer);
            if (clickCount >= 5) {
                clickCount = 0;
                dbUrlInput.value = DB_URL;
                settingsModal.classList.remove('hidden');
            }
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        };

        saveSettings.onclick = () => {
            DB_URL = dbUrlInput.value.trim() || DEFAULT_DB;
            localStorage.setItem('story_db_url', DB_URL);
            settingsModal.classList.add('hidden');
            fetchStories(); 
        };

        cancelSettings.onclick = () => settingsModal.classList.add('hidden');

        async function trackVisits() {
            try {
                const response = await fetch('https://api.countapi.xyz/hit/storiedb-visits/hits');
                const data = await response.json();
                currentRawVisitCount = data.value.toLocaleString();
                visitCount.textContent = `[${currentRawVisitCount}]`;
            } catch (err) {
                visitCount.textContent = ''; 
            }
        }

        function parseDatabase(text) {
            if (!text || !text.trim()) return [];
            const sections = text.replace(/\r\n/g, '\n').split(/\n-\n/);
            return sections.map(section => {
                const lines = section.trim().split('\n');
                const story = {};
                lines.forEach(line => {
                    const l = line.trim();
                    const lowerL = l.toLowerCase();
                    if (lowerL.startsWith('title:')) story.title = l.substring(6).trim();
                    if (lowerL.startsWith('text:')) story.text = l.substring(5).trim();
                    if (lowerL.startsWith('video:')) {
                        story.video = l.substring(6).trim();
                        story.isExternal = false;
                    }
                    if (lowerL.startsWith('videoe:')) {
                        story.video = l.substring(7).trim();
                        story.isExternal = true;
                    }
                    if (lowerL.startsWith('image:')) story.image = l.substring(6).trim();
                });
                return story;
            }).filter(s => s.title && s.title.toLowerCase() !== 'placeholder' && !s.title.startsWith('//'));
        }

        async function fetchStories() {
            try {
                const response = await fetch(DB_URL);
                if (!response.ok) throw new Error('Network error');
                const dataText = await response.text();
                stories = parseDatabase(dataText);
                updateStats(stories);
                renderStories(stories);
            } catch (err) {
                console.error("Fetch error:", err);
                renderStories([]); 
            }
        }

        function updateStats(items) {
            let v = 0, e = 0, t = 0, i = 0;
            items.forEach(s => {
                if (s.video) {
                    if (s.isExternal) e++; else v++;
                } else if (s.image) {
                    i++;
                } else {
                    t++;
                }
            });
            countVideo.textContent = v;
            countImage.textContent = i;
            countExternal.textContent = e;
            countText.textContent = t;
        }

        function injectDynamicData(text) {
            if (!text) return "";
            return text.replace(/\(visitors\)/gi, currentRawVisitCount);
        }

        function renderStories(items) {
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<div class="py-20 text-gray-500 text-center"><p>No stories found.</p></div>`;
                return;
            }

            items.forEach((story) => {
                const card = document.createElement('div');
                card.className = 'story-card p-5 rounded-2xl cursor-pointer';
                card.onclick = () => openStory(story);
                
                let typeLabel = '';
                if (story.video) {
                    typeLabel = !story.isExternal ? 
                        `<span class="text-[10px] bg-red-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-white">Video</span>` :
                        `<span class="text-[10px] bg-yellow-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-black">External</span>`;
                } else if (story.image) {
                    typeLabel = `<span class="text-[10px] bg-green-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-white">Image</span>`;
                } else {
                    typeLabel = `<span class="text-[10px] bg-blue-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest text-white">Text</span>`;
                }

                // Inject visitor count into both title and preview text
                const injectedTitle = injectDynamicData(story.title);
                const previewText = injectDynamicData(story.text || 'View story content...');

                card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        ${typeLabel}
                        <h2 class="text-lg font-semibold leading-tight">${injectedTitle}</h2>
                        <p class="text-gray-400 text-sm line-clamp-2">${previewText}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openStory(story) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            const injectedTitle = injectDynamicData(story.title);

            if (story.video && story.isExternal) {
                modalContent.innerHTML = `
                    <div class="flex-grow flex flex-col items-center justify-center text-center p-6">
                        <h1 class="text-2xl font-bold mb-4">${injectedTitle}</h1>
                        <div class="bg-[#111] p-6 rounded-2xl border border-yellow-600/50 mb-6">
                            <p class="text-yellow-500 font-semibold mb-2">External Content</p>
                            <p class="text-gray-400">Redirecting to official link...</p>
                        </div>
                        <a href="${story.video}" target="_blank" class="bg-white text-black px-8 py-3 rounded-full font-bold">Go to Story</a>
                    </div>
                `;
                setTimeout(() => { window.open(story.video, '_blank'); }, 1500);
                return;
            }

            let mediaHtml = '';
            if (story.video && !story.isExternal) {
                mediaHtml = `<div class="media-container flex-grow"><video controls autoplay playsinline loop><source src="${story.video}" type="video/mp4"></video></div>`;
            } else if (story.image) {
                mediaHtml = `<div class="media-container flex-grow"><img src="${story.image}" alt="story image"></div>`;
            }

            const cleanText = injectDynamicData((story.text || '').trim());
            const isMediaEntry = !!(story.video || story.image);

            modalContent.innerHTML = `
                ${mediaHtml}
                <div class="p-6 bg-gradient-to-t from-black via-black to-transparent">
                    <h1 class="text-2xl font-bold mb-2">${injectedTitle}</h1>
                    ${cleanText ? `
                        ${isMediaEntry ? '<p class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-2">Description</p>' : ''}
                        <div class="text-gray-300 text-lg leading-relaxed whitespace-pre-wrap pb-10">${cleanText}</div>
                    ` : ''}
                </div>
            `;
        }

        function filterItems() {
            const term = searchInput.value.toLowerCase();
            const filtered = stories.filter(s => {
                return s.title.toLowerCase().includes(term) || (s.text && s.text.toLowerCase().includes(term));
            });
            renderStories(filtered);
        }

        searchInput.oninput = filterItems;

        closeModal.onclick = () => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            modalContent.innerHTML = ''; 
        };

        randomBtn.onclick = () => {
            if (stories.length === 0) return;
            openStory(stories[Math.floor(Math.random() * stories.length)]);
        };

        window.onload = async () => {
            await trackVisits();
            fetchStories();
        };
    </script>
</body>
</html>
