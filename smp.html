<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --accent: #ff8c00;
            --black: #000000;
            --gray: #1a1a1a;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--black);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: monospace;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--black);
            color: var(--accent);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            text-transform: uppercase;
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--accent);
        }

        .recommendation-bar {
            font-size: 0.7rem;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: 1px;
            border-bottom: 1px dashed rgba(255, 140, 0, 0.3);
            padding-bottom: 5px;
        }

        .top-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .info-group {
            display: flex;
            gap: 15px;
        }

        .now-playing {
            font-size: 1.2rem;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .controls-top {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            position: relative;
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--black);
            border: 1px solid var(--accent);
            min-width: 160px;
            z-index: 1000;
            top: 100%;
            left: 0;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #222;
            display: block;
            text-align: left;
            width: 100%;
            background: none;
            color: var(--accent);
            border-left: none;
            border-right: none;
            border-top: none;
        }

        .dropdown-item:hover {
            background-color: var(--gray);
        }

        button, .input-label {
            background: none;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            text-transform: uppercase;
            display: inline-block;
        }

        button:active, .input-label:active {
            background: var(--accent);
            color: var(--black);
        }

        button:disabled {
            opacity: 0.3;
            border-color: #444;
            color: #444;
        }

        .progress-container {
            width: 100%;
            height: 20px;
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        #progress-bar {
            width: 100%;
            accent-color: var(--accent);
            cursor: pointer;
        }

        #playlist {
            flex-grow: 1;
            overflow-y: auto;
            list-style: none;
            padding: 10px;
        }

        .song-item {
            padding: 12px;
            border: 1px solid #333;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .song-item .track-info {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-item.active {
            border-color: var(--accent);
            background: var(--gray);
        }

        .needs-link {
            color: #ff4500;
            font-size: 0.7rem;
            display: block;
        }

        .full-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--black);
            z-index: 200;
            flex-direction: column;
            padding: 40px 20px;
            text-align: center;
        }

        #lyrics-content {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 1.5rem;
            line-height: 1.6;
            padding: 20px 0;
            text-transform: none;
        }

        .lyric-line {
            margin: 15px 0;
            opacity: 0.4;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .lyric-line:hover {
            opacity: 0.8;
        }

        .lyric-line.highlight {
            opacity: 1;
            font-weight: bold;
            text-decoration: underline;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            border: none;
            background: none;
            color: var(--accent);
            cursor: pointer;
        }

        .editor-container {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            width: 100%;
        }

        .editor-input {
            background: var(--gray);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px;
            width: 100%;
            max-width: 400px;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .color-presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border: 1px solid white;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        #meta-display {
            text-align: left;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border: 1px solid var(--accent);
            padding: 15px;
            background: var(--gray);
            font-size: 0.9rem;
        }

        #save-status {
            font-size: 0.7rem;
            height: 1em;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<header>
    <div class="recommendation-bar">LINKS RECOMMENDED FOR AUDIO</div>
    
    <div class="top-info">
        <span id="current-date">--/--/--</span>
        <div class="info-group">
            <span id="battery-status">BAT: --%</span>
            <span id="current-time">00:00:00</span>
        </div>
    </div>

    <div class="now-playing" id="track-title">NO TRACK SELECTED</div>
    
    <div class="controls-top">
        <div class="dropdown">
            <button class="dropdown-trigger">ADD AUDIO â–¼</button>
            <div class="dropdown-content">
                <button class="dropdown-item" onclick="document.getElementById('audio-upload').click()">FROM FILE</button>
                <button class="dropdown-item" id="link-import-btn">FROM LINK</button>
            </div>
        </div>
        <input type="file" id="audio-upload" accept="audio/*">
        
        <label class="input-label" for="lrc-upload">ADD LRC</label>
        <input type="file" id="lrc-upload" accept=".lrc">
        
        <button id="edit-btn" disabled>EDIT INFO</button>
        <button id="lyrics-btn" disabled>LYRICS</button>
        <button id="data-btn" disabled>FILE DATA</button>
        <button id="theme-btn">THEME</button>
        <button id="save-btn">SAVE LIST</button>
    </div>

    <div class="main-player-controls">
        <button id="prev-btn">PREV</button>
        <button id="play-pause-btn">PLAY</button>
        <button id="next-btn">NEXT</button>
        <button id="clear-btn" style="border-color: #600; color: #a00;">RESET</button>
    </div>

    <div class="progress-container">
        <input type="range" id="progress-bar" value="0" min="0" step="1">
    </div>
    <div id="time-display">00:00 / 00:00</div>
    <div id="save-status"></div>
</header>

<ul id="playlist"></ul>

<div id="lyrics-overlay" class="full-overlay">
    <button class="close-btn" id="close-lyrics">X</button>
    <div id="lyrics-content"></div>
</div>

<div id="editor-overlay" class="full-overlay">
    <button class="close-btn" id="close-editor">X</button>
    
    <div id="meta-section" class="editor-container">
        <h2 id="editor-title">EDIT METADATA</h2>
        <div id="edit-fields" style="width:100%; display: flex; flex-direction: column; align-items: center;">
            <p>TRACK NAME:</p>
            <input type="text" id="edit-name-input" class="editor-input">
            <button id="apply-edit-btn" style="margin-top:10px;">APPLY NAME</button>
        </div>
        <div id="data-fields" style="display:none; width:100%;">
            <div id="meta-display"></div>
        </div>
    </div>

    <div id="link-section" class="editor-container" style="display:none;">
        <h2>IMPORT VIA LINK</h2>
        <p>ENTER AUDIO URL:</p>
        <input type="text" id="link-input" class="editor-input" placeholder="https://example.com/song.mp3">
        <button id="apply-link-btn" style="margin-top:10px;">IMPORT LINK</button>
    </div>

    <div id="theme-section" class="editor-container" style="display:none;">
        <h2>ACCENT COLOR</h2>
        <div class="color-presets">
            <div class="color-swatch" style="background:#ff8c00;" data-color="#ff8c00"></div>
            <div class="color-swatch" style="background:#00ffcc;" data-color="#00ffcc"></div>
            <div class="color-swatch" style="background:#ff00ff;" data-color="#ff00ff"></div>
            <div class="color-swatch" style="background:#ffffff;" data-color="#ffffff"></div>
            <div class="color-swatch" style="background:#ff4444;" data-color="#ff4444"></div>
        </div>
        <p>CUSTOM HEX:</p>
        <input type="text" id="hex-input" class="editor-input" placeholder="#FFFFFF">
        <button id="auto-accent-btn">AUTO ACCENT: OFF</button>
    </div>
</div>

<audio id="audio-element"></audio>

<script>
    const audio = document.getElementById('audio-element');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const trackTitle = document.getElementById('track-title');
    const progressBar = document.getElementById('progress-bar');
    const timeDisplay = document.getElementById('time-display');
    const playlistEl = document.getElementById('playlist');
    const lyricsBtn = document.getElementById('lyrics-btn');
    const editBtn = document.getElementById('edit-btn');
    const dataBtn = document.getElementById('data-btn');
    const themeBtn = document.getElementById('theme-btn');
    const linkImportBtn = document.getElementById('link-import-btn');
    const lyricsOverlay = document.getElementById('lyrics-overlay');
    const editorOverlay = document.getElementById('editor-overlay');
    const lyricsContent = document.getElementById('lyrics-content');
    const audioUpload = document.getElementById('audio-upload');
    const lrcUpload = document.getElementById('lrc-upload');
    const saveBtn = document.getElementById('save-btn');
    const saveStatus = document.getElementById('save-status');
    const editNameInput = document.getElementById('edit-name-input');
    const applyEditBtn = document.getElementById('apply-edit-btn');
    const linkInput = document.getElementById('link-input');
    const applyLinkBtn = document.getElementById('apply-link-btn');
    const hexInput = document.getElementById('hex-input');
    const autoAccentBtn = document.getElementById('auto-accent-btn');
    const metaDisplay = document.getElementById('meta-display');
    const batteryStatus = document.getElementById('battery-status');

    let playlist = [];
    let currentIndex = -1;
    let autoAccent = false;

    function saveAllToStorage() {
        const data = playlist.map(item => ({ 
            name: item.name, 
            lyrics: item.lyrics, 
            fileMeta: item.fileMeta,
            isLink: item.isLink,
            savedUrl: item.isLink ? item.url : null 
        }));
        localStorage.setItem('minimal_player_playlist', JSON.stringify(data));
        localStorage.setItem('player_auto_accent', autoAccent);
        if (!autoAccent) {
            localStorage.setItem('player_accent', document.documentElement.style.getPropertyValue('--accent'));
        }
    }

    function showStatus(msg) {
        saveStatus.innerText = msg;
        setTimeout(() => saveStatus.innerText = "", 3000);
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('current-time').innerText = now.toLocaleTimeString();
        document.getElementById('current-date').innerText = now.toLocaleDateString();
        if (autoAccent) {
            const h = now.getHours();
            setAccent((h >= 6 && h < 18) ? "#ffffff" : "#ff4444", false);
        }
    }

    async function updateBattery() {
        if ('getBattery' in navigator) {
            try {
                const battery = await navigator.getBattery();
                const updateInfo = () => {
                    const level = Math.round(battery.level * 100);
                    const charging = battery.charging ? "+" : "";
                    batteryStatus.innerText = `BAT: ${level}%${charging}`;
                };
                updateInfo();
                battery.addEventListener('levelchange', updateInfo);
                battery.addEventListener('chargingchange', updateInfo);
            } catch (e) {
                batteryStatus.style.display = 'none';
            }
        } else {
            batteryStatus.style.display = 'none';
        }
    }

    window.onload = () => {
        autoAccent = localStorage.getItem('player_auto_accent') === 'true';
        autoAccentBtn.innerText = `AUTO ACCENT: ${autoAccent ? 'ON' : 'OFF'}`;
        const savedAccent = localStorage.getItem('player_accent');
        if (savedAccent && !autoAccent) setAccent(savedAccent, false);
        const savedPlaylist = localStorage.getItem('minimal_player_playlist');
        if (savedPlaylist) {
            try {
                const raw = JSON.parse(savedPlaylist);
                playlist = raw.map(item => ({
                    ...item,
                    url: item.isLink ? item.savedUrl : null
                }));
                updateUI();
            } catch (e) {}
        }
        setInterval(updateClock, 1000);
        updateClock();
        updateBattery();
    };

    function setAccent(color, save = true) {
        document.documentElement.style.setProperty('--accent', color);
        if (save && !autoAccent) localStorage.setItem('player_accent', color);
    }

    saveBtn.onclick = () => {
        saveAllToStorage();
        showStatus("ALL SETTINGS SAVED");
    };

    function updateUI() {
        playlistEl.innerHTML = '';
        playlist.forEach((track, index) => {
            const li = document.createElement('li');
            li.className = `song-item ${index === currentIndex ? 'active' : ''}`;
            const info = document.createElement('div');
            info.className = 'track-info';
            info.innerHTML = `<span>${track.name}</span>${!track.url ? '<span class="needs-link">[RE-LINK LOCAL FILE]</span>' : ''}`;
            const btn = document.createElement('button');
            btn.innerText = track.url ? "LOAD" : (track.isLink ? "LINK" : "FILE");
            btn.onclick = () => {
                if (track.url) playTrack(index);
                else { 
                    currentIndex = index;
                    if (track.isLink) {
                        openLinkImport();
                    } else {
                        audioUpload.click();
                    }
                }
            };
            li.appendChild(info);
            li.appendChild(btn);
            playlistEl.appendChild(li);
        });
        if (currentIndex > -1) {
            trackTitle.innerText = playlist[currentIndex].name;
            lyricsBtn.disabled = !playlist[currentIndex].lyrics;
            editBtn.disabled = false;
            dataBtn.disabled = !playlist[currentIndex].fileMeta;
        }
    }

    function hideAllEditorSections() {
        document.getElementById('meta-section').style.display = 'none';
        document.getElementById('theme-section').style.display = 'none';
        document.getElementById('link-section').style.display = 'none';
    }

    editBtn.onclick = () => {
        hideAllEditorSections();
        document.getElementById('meta-section').style.display = 'flex';
        document.getElementById('edit-fields').style.display = 'flex';
        document.getElementById('data-fields').style.display = 'none';
        document.getElementById('editor-title').innerText = "EDIT METADATA";
        editNameInput.value = playlist[currentIndex].name;
        editorOverlay.style.display = 'flex';
    };

    dataBtn.onclick = () => {
        const meta = playlist[currentIndex]?.fileMeta;
        if (!meta) return;
        hideAllEditorSections();
        document.getElementById('meta-section').style.display = 'flex';
        document.getElementById('edit-fields').style.display = 'none';
        document.getElementById('data-fields').style.display = 'block';
        document.getElementById('editor-title').innerText = "FILE DATA";
        metaDisplay.innerHTML = Object.entries(meta).map(([k, v]) => `<div>${k.replace(/([A-Z])/g, ' $1')}: ${v}</div>`).join('');
        editorOverlay.style.display = 'flex';
    };

    themeBtn.onclick = () => {
        hideAllEditorSections();
        document.getElementById('theme-section').style.display = 'flex';
        editorOverlay.style.display = 'flex';
    };

    function openLinkImport() {
        hideAllEditorSections();
        document.getElementById('link-section').style.display = 'flex';
        linkInput.value = (currentIndex > -1 && playlist[currentIndex].isLink) ? playlist[currentIndex].url : "";
        editorOverlay.style.display = 'flex';
    }

    linkImportBtn.onclick = openLinkImport;

    document.getElementById('close-editor').onclick = () => editorOverlay.style.display = 'none';

    document.querySelectorAll('.color-swatch').forEach(swatch => {
        swatch.onclick = () => {
            autoAccent = false;
            autoAccentBtn.innerText = "AUTO ACCENT: OFF";
            setAccent(swatch.dataset.color);
            saveAllToStorage();
        };
    });

    hexInput.oninput = (e) => {
        const val = e.target.value;
        if (val.length === 7 && val.startsWith('#')) {
            autoAccent = false;
            autoAccentBtn.innerText = "AUTO ACCENT: OFF";
            setAccent(val);
            saveAllToStorage();
        }
    };

    autoAccentBtn.onclick = () => {
        autoAccent = !autoAccent;
        autoAccentBtn.innerText = `AUTO ACCENT: ${autoAccent ? 'ON' : 'OFF'}`;
        saveAllToStorage();
        updateClock();
    };

    applyEditBtn.onclick = () => {
        const newName = editNameInput.value.trim();
        if (newName && currentIndex > -1) {
            playlist[currentIndex].name = newName;
            updateUI();
            saveAllToStorage();
            editorOverlay.style.display = 'none';
        }
    };

    applyLinkBtn.onclick = () => {
        const url = linkInput.value.trim();
        if (!url) return;

        const name = url.split('/').pop().split('?')[0] || "REMOTE TRACK";
        const fileMeta = { source: "URL", imported: new Date().toLocaleDateString() };

        if (currentIndex > -1 && playlist[currentIndex].isLink && !playlist[currentIndex].url) {
            // Repairing an existing link track
            playlist[currentIndex].url = url;
            playTrack(currentIndex);
        } else {
            // Adding new track
            playlist.push({ name, url, fileMeta, lyrics: null, isLink: true });
            if (currentIndex === -1) playTrack(playlist.length - 1);
        }

        updateUI();
        saveAllToStorage();
        editorOverlay.style.display = 'none';
    };

    audioUpload.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        const name = file.name.replace(/\.[^/.]+$/, "");
        
        const fileMeta = {
            size: (file.size / 1024 / 1024).toFixed(2) + " MB",
            type: file.type || "UNKNOWN",
            lastModified: new Date(file.lastModified).toLocaleDateString()
        };

        if (currentIndex > -1 && !playlist[currentIndex].isLink && !playlist[currentIndex].url) {
            playlist[currentIndex].url = url;
            playlist[currentIndex].fileMeta = fileMeta;
            if (!playlist[currentIndex].name) playlist[currentIndex].name = name;
            playTrack(currentIndex);
        } else {
            playlist.push({ name, url, fileMeta, lyrics: null, isLink: false });
            if (currentIndex === -1) playTrack(playlist.length - 1);
        }
        updateUI();
        saveAllToStorage();
    };

    lrcUpload.onchange = (e) => {
        const file = e.target.files[0];
        if (!file || currentIndex === -1) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            playlist[currentIndex].lyrics = parseLRC(event.target.result);
            updateUI();
            saveAllToStorage();
        };
        reader.readAsText(file);
    };

    function parseLRC(text) {
        const lines = text.split('\n');
        const res = [];
        const reg = /\[(\d+):(\d+\.\d+)\]/;
        lines.forEach(line => {
            const m = reg.exec(line);
            if (m) res.push({ time: parseFloat(m[1]) * 60 + parseFloat(m[2]), text: line.replace(reg, '').trim() });
        });
        return res.sort((a, b) => a.time - b.time);
    }

    function playTrack(idx) {
        if (idx < 0 || idx >= playlist.length || !playlist[idx].url) return;
        currentIndex = idx;
        audio.src = playlist[currentIndex].url;
        audio.play().catch(err => {
            console.error("Playback failed:", err);
            showStatus("LOAD ERROR: CHECK LINK");
        });
        playPauseBtn.innerText = "PAUSE";
        updateUI();
    }

    playPauseBtn.onclick = () => {
        if (!audio.src) return;
        if (audio.paused) { audio.play(); playPauseBtn.innerText = "PAUSE"; }
        else { audio.pause(); playPauseBtn.innerText = "PLAY"; }
    };

    document.getElementById('next-btn').onclick = () => playTrack((currentIndex + 1) % playlist.length);
    document.getElementById('prev-btn').onclick = () => playTrack((currentIndex - 1 + playlist.length) % playlist.length);
    document.getElementById('clear-btn').onclick = () => {
        if(confirm("WIPE ALL DATA?")) { localStorage.clear(); location.reload(); }
    };

    audio.ontimeupdate = () => {
        if (!isNaN(audio.duration)) {
            progressBar.max = audio.duration;
            progressBar.value = audio.currentTime;
            const fmt = (t) => Math.floor(t / 60) + ":" + Math.floor(t % 60).toString().padStart(2, '0');
            timeDisplay.innerText = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
            highlightLyrics(audio.currentTime);
        }
    };

    progressBar.oninput = () => audio.currentTime = progressBar.value;
    lyricsBtn.onclick = () => { renderLyrics(); lyricsOverlay.style.display = 'flex'; };
    document.getElementById('close-lyrics').onclick = () => lyricsOverlay.style.display = 'none';

    function renderLyrics() {
        const l = playlist[currentIndex]?.lyrics;
        if (!l) return;
        lyricsContent.innerHTML = '';
        l.forEach((line, idx) => {
            const d = document.createElement('div');
            d.className = 'lyric-line';
            d.id = `lyric-${idx}`;
            d.innerText = line.text || "...";
            d.onclick = () => {
                audio.currentTime = line.time;
                if (audio.paused) audio.play();
            };
            lyricsContent.appendChild(d);
        });
    }

    function highlightLyrics(curr) {
        const l = playlist[currentIndex]?.lyrics;
        if (!l || lyricsOverlay.style.display !== 'flex') return;
        let idx = -1;
        for (let i = 0; i < l.length; i++) {
            if (curr >= l[i].time) idx = i;
            else break;
        }
        if (idx !== -1) {
            document.querySelectorAll('.lyric-line').forEach(el => el.classList.remove('highlight'));
            const active = document.getElementById(`lyric-${idx}`);
            if (active) {
                active.classList.add('highlight');
                active.scrollIntoView({ behavior: 'auto', block: 'center' });
            }
        }
    }

    audio.onended = () => document.getElementById('next-btn').click();
</script>
</body>
</html>
