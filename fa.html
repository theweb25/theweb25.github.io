<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Alarm Simulator - v2.5.0 Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @keyframes strobe-flash {
            0% { background-color: rgba(255, 255, 255, 1); }
            100% { background-color: rgba(255, 255, 255, 0); }
        }
        .strobe-effect {
            animation: strobe-flash 0.15s ease-out forwards;
        }
        .pull-station-body {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.3), 0 10px 20px rgba(0,0,0,0.5);
            border-bottom: 8px solid #7f1d1d;
        }
        .pull-station-emitter {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.3), 0 10px 20px rgba(0,0,0,0.5);
            border-bottom: 8px solid #1e3a8a;
        }
        .t-bar {
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-origin: top center;
            cursor: pointer;
        }
        .t-bar.pulled {
            transform: rotateX(140deg);
        }
        .hidden-pane { display: none; }
        .perspective-1000 { perspective: 1000px; }
        
        .debug-panel {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(51, 65, 85, 1);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        .version-tag {
            font-family: ui-monospace, monospace;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden font-sans">

    <!-- Version Corner Tag -->
    <div class="fixed bottom-4 right-4 z-[60] version-tag text-[10px] text-slate-600 font-bold uppercase tracking-widest pointer-events-none">
        System Ver: 2.5.0-Stable
    </div>

    <!-- Start Overlay -->
    <div id="audio-gate" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center text-center p-6">
        <div class="max-w-xs">
            <div class="w-20 h-20 bg-red-600 rounded-full mx-auto mb-6 flex items-center justify-center animate-pulse shadow-[0_0_30px_rgba(220,38,38,0.5)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
            </div>
            <h1 class="text-2xl font-black mb-2 uppercase tracking-tighter text-white">Diagnostic Boot</h1>
            <p class="text-slate-400 mb-8 text-sm">Calibration required for frequency-dependent remote activation.</p>
            <button id="start-app" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-slate-200 transition-all active:scale-95">
                Start Diagnostics
            </button>
        </div>
    </div>

    <!-- Strobe Overlay -->
    <div id="strobe-overlay" class="fixed inset-0 pointer-events-none z-50 bg-white opacity-0"></div>

    <div class="max-w-md w-full z-10 space-y-4">
        <!-- Mode Switcher -->
        <div class="flex bg-slate-900 p-1.5 rounded-2xl border border-slate-800 shadow-xl">
            <button id="switch-emitter" class="flex-1 py-3 rounded-xl font-bold transition-all bg-blue-600 text-white shadow-lg">Emitter Station</button>
            <button id="switch-receiver" class="flex-1 py-3 rounded-xl font-bold transition-all text-slate-400 hover:text-white">Receiver Station</button>
        </div>

        <!-- EMITTER PANE -->
        <div id="pane-emitter" class="space-y-4">
            <div class="pull-station-emitter w-full aspect-[3/4] rounded-2xl p-8 flex flex-col items-center justify-between border-t-4 border-blue-400 relative">
                <div class="text-center">
                    <h2 class="text-white text-3xl font-black italic tracking-tighter leading-none uppercase">Signal</h2>
                    <p class="text-[10px] font-bold text-blue-200 mt-2 uppercase tracking-widest">Diagnostic Mode</p>
                </div>

                <div id="emitter-pull-trigger" class="relative group cursor-pointer perspective-1000">
                    <div class="w-32 h-44 bg-blue-900/50 rounded-xl border-2 border-blue-950 flex justify-center shadow-inner">
                        <div id="emitter-handle" class="t-bar w-24 h-14 bg-white rounded-lg mt-6 shadow-2xl flex flex-col items-center justify-center relative z-20">
                            <div class="w-16 h-2 bg-slate-300 rounded-full mb-1"></div>
                            <span class="text-[9px] text-blue-700 font-black uppercase italic" id="emitter-label">Pull & Hold</span>
                        </div>
                        <div class="absolute top-6 w-5 h-28 bg-slate-400 rounded-b-lg border-x border-slate-500"></div>
                    </div>
                </div>

                <div class="flex flex-col gap-2 items-center w-full">
                    <div class="flex items-center gap-3 bg-blue-950/40 px-4 py-2 rounded-full border border-blue-700/30">
                        <div id="emitter-led" class="w-3 h-3 rounded-full bg-blue-900 transition-all duration-100"></div>
                        <span class="text-xs font-mono font-bold text-blue-300 tracking-wider">FREQ: <span id="emitter-freq-display">620</span>Hz</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-freq-trigger" class="bg-blue-600 hover:bg-blue-500 text-[9px] px-3 py-1 rounded-md font-bold uppercase transition-colors">Set Trigger (620)</button>
                        <button id="btn-freq-reset" class="bg-slate-700 hover:bg-slate-600 text-[9px] px-3 py-1 rounded-md font-bold uppercase transition-colors">Set Reset (720)</button>
                    </div>
                </div>
            </div>

            <div class="debug-panel p-4 rounded-xl text-[10px] space-y-2 border-l-4 border-blue-500 shadow-xl">
                <div class="flex justify-between">
                    <span>OSC_STATUS:</span>
                    <span id="dbg-emit-status" class="text-blue-400 font-bold">STANDBY</span>
                </div>
                <div class="flex justify-between">
                    <span>OUTPUT_GAIN:</span>
                    <span id="dbg-emit-gain" class="text-slate-400">0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>REPEATER:</span>
                    <span id="dbg-emit-repeater" class="text-slate-500 font-bold uppercase">OFF</span>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-800">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-400 font-bold uppercase tracking-tight">Enable Auto-Repeater</span>
                        <input type="checkbox" id="chain-toggle" class="accent-blue-500 h-4 w-4">
                    </div>
                </div>
            </div>
        </div>

        <!-- RECEIVER PANE -->
        <div id="pane-receiver" class="hidden-pane space-y-4">
            <div class="pull-station-body w-full aspect-[3/4] rounded-2xl p-8 flex flex-col items-center justify-between border-t-4 border-red-400 relative">
                <div class="text-center">
                    <h2 class="text-white text-3xl font-black italic tracking-tighter leading-none uppercase">Fire</h2>
                    <p class="text-[10px] font-bold text-red-200 mt-2 uppercase tracking-widest">Diagnostic Mode</p>
                </div>

                <div id="receiver-pull-trigger" class="relative group cursor-pointer perspective-1000">
                    <div class="w-32 h-44 bg-red-900/50 rounded-xl border-2 border-red-950 flex justify-center shadow-inner">
                        <div id="receiver-handle" class="t-bar w-24 h-14 bg-white rounded-lg mt-6 shadow-2xl flex flex-col items-center justify-center relative z-20">
                            <div class="w-16 h-2 bg-slate-300 rounded-full mb-1"></div>
                            <span class="text-[9px] text-red-700 font-black uppercase italic">Pull Down</span>
                        </div>
                        <div class="absolute top-6 w-5 h-28 bg-slate-400 rounded-b-lg border-x border-slate-500"></div>
                    </div>
                </div>

                <div id="sounder-unit" class="w-16 h-16 bg-slate-800 rounded-full border-4 border-slate-700 flex items-center justify-center relative overflow-hidden shadow-2xl">
                    <div id="strobe-inner" class="absolute inset-0 bg-white opacity-0"></div>
                    <div class="w-8 h-8 rounded-full border-2 border-slate-600 z-10"></div>
                </div>
            </div>

            <div class="debug-panel p-4 rounded-xl text-[10px] space-y-3 border-l-4 border-red-500 shadow-xl">
                <div class="flex justify-between items-center mb-1">
                    <span>LIVE_SPECTRUM:</span>
                    <span id="dbg-recv-peak" class="font-bold text-red-400">0 Hz</span>
                </div>
                
                <div class="space-y-1">
                    <div class="flex justify-between text-[8px] text-slate-500">
                        <span>INPUT: <span id="dbg-recv-pwr">-Infinity dB</span></span>
                        <span>GATE: <span id="dbg-recv-thresh">-50 dB</span></span>
                    </div>
                    <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden flex relative">
                        <div id="dbg-bar-pwr" class="h-full bg-slate-600 transition-all duration-75" style="width: 0%"></div>
                        <div id="dbg-bar-marker" class="absolute h-full w-0.5 bg-red-500 shadow-[0_0_5px_red] top-0" style="left: 50%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2 pt-2 border-t border-slate-800">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500 font-bold">BANDWIDTH:</span>
                        <div class="text-white">620 / 720 Hz Â± 25</div>
                    </div>
                    <div>
                        <span class="text-slate-500 font-bold">SENSITIVITY:</span>
                        <input type="range" id="sensitivity-slider" min="-80" max="-20" value="-50" class="w-full accent-red-500">
                    </div>
                </div>

                <button id="mic-activate" class="w-full bg-red-600/20 hover:bg-red-600/40 text-red-500 py-2 rounded-lg font-bold border border-red-900/50 transition-all text-[9px] uppercase tracking-widest">
                    Open Listen Pipeline
                </button>
                <div id="listening-indicator" class="hidden text-center text-green-500 font-bold animate-pulse uppercase tracking-tighter">
                    DSP Receiver Active
                </div>
            </div>
        </div>

        <!-- Universal Reset -->
        <button id="reset-btn" class="hidden w-full bg-white text-black py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-slate-200 transition-all active:scale-95 shadow-2xl border-b-4 border-slate-300">
            System Reset
        </button>
    </div>

    <script>
        const FREQ_SIGNAL = 620;
        const FREQ_RESET = 720;
        const FREQ_ALARM = 520;
        const TOLERANCE = 25;
        let isAlarmActive = false;
        let isMicOn = false;
        let chainReactionEnabled = false;
        let currentEmitterFreq = FREQ_SIGNAL;

        let audioCtx;
        let emitterOsc, emitterGain;
        let sounderOsc, sounderGain;
        let resetSynth;

        // Debug Elements
        const dbgEmitStatus = document.getElementById('dbg-emit-status');
        const dbgEmitGain = document.getElementById('dbg-emit-gain');
        const dbgEmitRepeater = document.getElementById('dbg-emit-repeater');
        const dbgRecvPeak = document.getElementById('dbg-recv-peak');
        const dbgRecvPwr = document.getElementById('dbg-recv-pwr');
        const dbgRecvThresh = document.getElementById('dbg-recv-thresh');
        const dbgBarPwr = document.getElementById('dbg-bar-pwr');
        const dbgBarMarker = document.getElementById('dbg-bar-marker');

        const setupAudio = () => {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            emitterOsc = audioCtx.createOscillator();
            emitterGain = audioCtx.createGain();
            emitterOsc.type = 'sine';
            emitterOsc.frequency.setValueAtTime(currentEmitterFreq, audioCtx.currentTime);
            emitterGain.gain.setValueAtTime(0, audioCtx.currentTime);
            emitterOsc.connect(emitterGain);
            emitterGain.connect(audioCtx.destination);
            emitterOsc.start();

            sounderOsc = audioCtx.createOscillator();
            sounderGain = audioCtx.createGain();
            sounderOsc.type = 'square';
            sounderOsc.frequency.setValueAtTime(FREQ_ALARM, audioCtx.currentTime);
            sounderGain.gain.setValueAtTime(0, audioCtx.currentTime);
            sounderOsc.connect(sounderGain);
            sounderGain.connect(audioCtx.destination);
            sounderOsc.start();

            resetSynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 }
            }).toDestination();
        };

        const meter = new Tone.FFT(4096);
        const mic = new Tone.UserMedia();
        mic.connect(meter);

        const audioGate = document.getElementById('audio-gate');
        const startApp = document.getElementById('start-app');
        const strobeOverlay = document.getElementById('strobe-overlay');
        const emitterHandle = document.getElementById('emitter-handle');
        const receiverHandle = document.getElementById('receiver-handle');
        const emitterLed = document.getElementById('emitter-led');
        const resetBtn = document.getElementById('reset-btn');
        const listeningIndicator = document.getElementById('listening-indicator');
        const strobeInner = document.getElementById('strobe-inner');
        const sensSlider = document.getElementById('sensitivity-slider');
        const chainToggle = document.getElementById('chain-toggle');
        const emitterFreqDisplay = document.getElementById('emitter-freq-display');
        const emitterLabel = document.getElementById('emitter-label');

        startApp.onclick = async () => {
            setupAudio();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            await Tone.start();
            audioGate.classList.add('hidden');
        };

        const panes = { emitter: document.getElementById('pane-emitter'), receiver: document.getElementById('pane-receiver') };
        const switches = { emitter: document.getElementById('switch-emitter'), receiver: document.getElementById('switch-receiver') };

        switches.emitter.onclick = () => {
            panes.emitter.classList.remove('hidden-pane');
            panes.receiver.classList.add('hidden-pane');
            switches.emitter.className = "flex-1 py-3 rounded-xl font-bold transition-all bg-blue-600 text-white shadow-lg";
            switches.receiver.className = "flex-1 py-3 rounded-xl font-bold transition-all text-slate-400 hover:text-white";
        };

        switches.receiver.onclick = () => {
            panes.receiver.classList.remove('hidden-pane');
            panes.emitter.classList.add('hidden-pane');
            switches.receiver.className = "flex-1 py-3 rounded-xl font-bold transition-all bg-red-600 text-white shadow-lg";
            switches.emitter.className = "flex-1 py-3 rounded-xl font-bold transition-all text-slate-400 hover:text-white";
        };

        // Emitter Frequency Controls
        document.getElementById('btn-freq-trigger').onclick = () => {
            currentEmitterFreq = FREQ_SIGNAL;
            emitterFreqDisplay.textContent = FREQ_SIGNAL;
            emitterLabel.textContent = "Pull & Hold";
            if(emitterOsc) emitterOsc.frequency.setValueAtTime(FREQ_SIGNAL, audioCtx.currentTime);
        };
        document.getElementById('btn-freq-reset').onclick = () => {
            currentEmitterFreq = FREQ_RESET;
            emitterFreqDisplay.textContent = FREQ_RESET;
            emitterLabel.textContent = "Reset Signal";
            if(emitterOsc) emitterOsc.frequency.setValueAtTime(FREQ_RESET, audioCtx.currentTime);
        };

        const startEmitting = () => {
            if (!emitterGain) return;
            emitterHandle.classList.add('pulled');
            emitterLed.classList.replace('bg-blue-900', 'bg-blue-400');
            emitterLed.classList.add('shadow-[0_0_15px_#60a5fa]');
            emitterGain.gain.setTargetAtTime(0.9, audioCtx.currentTime, 0.05);
            dbgEmitStatus.textContent = "EMITTING";
            dbgEmitStatus.className = "text-blue-400 font-bold animate-pulse";
            dbgEmitGain.textContent = "0.90";
        };

        const stopEmitting = () => {
            if (!emitterGain || (isAlarmActive && chainReactionEnabled)) return;
            emitterHandle.classList.remove('pulled');
            emitterLed.classList.replace('bg-blue-400', 'bg-blue-900');
            emitterLed.classList.remove('shadow-[0_0_15px_#60a5fa]');
            emitterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);
            dbgEmitStatus.textContent = "STANDBY";
            dbgEmitStatus.className = "text-slate-500 font-bold";
            dbgEmitGain.textContent = "0.00";
        };

        const emitterTrigger = document.getElementById('emitter-pull-trigger');
        emitterTrigger.onmousedown = startEmitting;
        emitterTrigger.onmouseup = stopEmitting;
        emitterTrigger.onmouseleave = stopEmitting;
        emitterTrigger.ontouchstart = (e) => { e.preventDefault(); startEmitting(); };
        emitterTrigger.ontouchend = stopEmitting;

        let alarmInterval;
        function triggerAlarm() {
            if (isAlarmActive) return;
            isAlarmActive = true;
            resetBtn.classList.remove('hidden');

            if (chainReactionEnabled) startEmitting();

            const pattern = [1, 0, 1, 0, 1, 0, 0, 0]; 
            let step = 0;

            alarmInterval = setInterval(() => {
                if (pattern[step % 8] === 1) {
                    sounderGain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    strobeOverlay.classList.remove('strobe-effect');
                    void strobeOverlay.offsetWidth; 
                    strobeOverlay.classList.add('strobe-effect');
                    strobeInner.style.opacity = "1";
                } else {
                    sounderGain.gain.setValueAtTime(0, audioCtx.currentTime);
                    strobeInner.style.opacity = "0";
                }
                step++;
            }, 500);
        }

        function resetAlarm() {
            if (!isAlarmActive) return;
            
            isAlarmActive = false;
            clearInterval(alarmInterval);
            sounderGain.gain.setValueAtTime(0, audioCtx.currentTime);
            resetBtn.classList.add('hidden');
            receiverHandle.classList.remove('pulled');
            strobeInner.style.opacity = "0";
            strobeOverlay.classList.remove('strobe-effect');
            
            // Handle emitter if it was in repeater mode
            stopEmitting();

            // Play Reset Tone Sequence
            const now = Tone.now();
            resetSynth.triggerAttackRelease("G4", "16n", now);
            resetSynth.triggerAttackRelease("B4", "16n", now + 0.1);
            resetSynth.triggerAttackRelease("D5", "8n", now + 0.2);
        }

        sensSlider.oninput = (e) => {
            dbgRecvThresh.textContent = e.target.value + " dB";
            const percentage = ((parseInt(e.target.value) + 80) / 60) * 100;
            dbgBarMarker.style.left = `${percentage}%`;
        };

        document.getElementById('mic-activate').onclick = async () => {
            mic.open().then(() => {
                isMicOn = true;
                document.getElementById('mic-activate').classList.add('hidden');
                listeningIndicator.classList.remove('hidden');
                detectFrequency();
            });
        };

        function detectFrequency() {
            if (!isMicOn) return;
            requestAnimationFrame(detectFrequency);

            const values = meter.getValue();
            let peakFreq = 0;
            let peakVal = -Infinity;

            for (let i = 0; i < values.length; i++) {
                if (values[i] > peakVal) {
                    peakVal = values[i];
                    peakFreq = (i * audioCtx.sampleRate) / (values.length * 2);
                }
            }

            dbgRecvPeak.textContent = `${Math.round(peakFreq)} Hz`;
            dbgRecvPwr.textContent = `${Math.round(peakVal)} dB`;
            
            const threshold = parseInt(sensSlider.value);
            const percentage = ((peakVal + 80) / 60) * 100;
            dbgBarPwr.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
            
            if (peakVal > threshold) {
                dbgBarPwr.classList.replace('bg-slate-600', 'bg-red-500');
                
                // Detection Logic
                const isTriggerDetected = Math.abs(peakFreq - FREQ_SIGNAL) < TOLERANCE;
                const isResetDetected = Math.abs(peakFreq - FREQ_RESET) < TOLERANCE;

                if (isTriggerDetected && !isAlarmActive) {
                    triggerAlarm();
                } else if (isResetDetected && isAlarmActive) {
                    resetAlarm();
                }
            } else {
                dbgBarPwr.classList.replace('bg-red-500', 'bg-slate-600');
            }
        }

        chainToggle.onchange = (e) => { 
            chainReactionEnabled = e.target.checked; 
            dbgEmitRepeater.textContent = chainReactionEnabled ? "ACTIVE" : "OFF";
            dbgEmitRepeater.className = chainReactionEnabled ? "text-green-400 font-bold uppercase" : "text-slate-500 font-bold uppercase";
        };

        document.getElementById('receiver-pull-trigger').onclick = () => {
            if (!isAlarmActive) {
                receiverHandle.classList.add('pulled');
                setTimeout(triggerAlarm, 300);
            }
        };

        resetBtn.onclick = resetAlarm;
        
        const initialPercentage = ((parseInt(sensSlider.value) + 80) / 60) * 100;
        dbgBarMarker.style.left = `${initialPercentage}%`;
    </script>
</body>
</html>

